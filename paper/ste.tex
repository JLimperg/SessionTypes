%TODO define command for unit; semantic commands for other Stys
%TODO clear up references to equations of definitions
\documentclass{llncs}
\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{amsfonts}
\usepackage{semantic}

\newcommand*{\Msg}{\mathrm{Msg}}
\newcommand*{\Var}{\mathrm{Var}}
\newcommand*{\Sym}{\mathrm{Sym}}
\newcommand*{\Refl}{\mathrm{Refl}}
\newcommand*{\Trans}{\mathrm{Trans}}
\newcommand*{\Ty}{\mathrm{Ty}}
\newcommand*{\Tl}{\mathrm{Tl}}
\renewcommand*{\S}{\mathfrak{S}}
\newcommand*{\lfp}{\mathrm{lfp}}
\newcommand*{\gfp}{\mathrm{gfp}}
\newcommand*{\cs}{\mathrm{cs}}
\newcommand*{\Shape}{\mathrm{Shape}}
\newcommand*{\shape}{\mathrm{shape}}
\newcommand*{\unitS}{\mathrm{unitS}}
\newcommand*{\sendS}{\mathrm{sendS}}
\newcommand*{\recvS}{\mathrm{recvS}}
\newcommand*{\echoiceS}{\mathrm{echoiceS}}
\newcommand*{\ichoiceS}{\mathrm{ichoiceS}}
\newcommand*{\muS}{\mathrm{muS}}
\newcommand*{\varS}{\mathrm{varS}}
\newcommand*{\sequiv}{\sim}
\newcommand*{\nsequiv}{\not\sim}
\newcommand*{\union}{\cup}
\newcommand*{\send}{\mathord{!}}
\newcommand*{\recv}{\mathord{?}}
\newcommand*{\echoice}{\oplus}
\newcommand*{\ichoice}{\mathop{\&}}
\newcommand*{\concat}{\cdot}
\newcommand*{\ok}[1]{\text{$#1$ {\normalfont \rmfamily ok}}}
\newcommand*{\checked}[1]{\text{$#1$ {\normalfont \rmfamily checked}}}
\newcommand*{\wf}[1]{\text{$#1$ {\normalfont \rmfamily wellformed}}}
\newcommand*{\contractive}[1]{\text{$#1$ {\normalfont \rmfamily contractive}}}
\newcommand*{\envimpl}       [2]{#1 \vdash #2}
\newcommand*{\envimplchecked}[2]{\envimpl{#1}{\checked{#2}}}
\newcommand*{\envimplok}     [2]{\envimpl{#1}{\ok{#2}}}
\renewcommand*{\|}{\;|\;}
\renewcommand*{\epsilon}{\varepsilon}
\newcommand*{\eqwith}[1]{\mathrel{\overset{\makebox[0pt]{\mbox{\normalfont\tiny\rmfamily #1}}}{=}}}
\newcommand*{\machdef}[1]{Machine definition: #1}
\newcommand*{\machdefc}[1]{Machine definition: \code{#1}.}
\newcommand*{\machproof}[1]{Machine proof: #1}
\newcommand*{\machproofc}[1]{Machine proof: \code{#1}.}
\newcommand*{\code}[1]{\texttt{#1}}

\begin{document}
\title{Two Definitions of Equivalence on Session Types}
\author{Jannis Limperg}
\institute{Freiburg University}
\maketitle

\begin{definition}[Messages and Variables]
  $\Msg$ and $\Var$ are disjunct infinite sets equipped with a decidable
  equality.

  In the following, we use $B$ for messages and $X, Y, \dots$ for variables.

  \machdef{\code{Msg.Msg} and \code{Var.Var} resp.}
\end{definition}


\begin{definition}[Session Types]
  The set $\Ty$ of session types is defined inductively by the following
  inference rules:
  \label{def:session_types}
  \begin{align*}
    1 \in \Ty \\
    \send B.S \in Ty &\quad \forall B \in Msg, S \in \Ty \\
    \recv B.S \in Ty &\quad \forall B \in Msg, S \in \Ty \\
    S_1 \echoice S_2 \in \Ty &\quad \forall S_1, S_2 \in \Ty \\
    S_1 \ichoice S_2 \in \Ty &\quad \forall S_1, S_2 \in \Ty \\
    \mu X.S \in \Ty &\quad \forall X \in \Var, S \in \Ty \\
    X \in Ty &\quad \forall X \in \Var
  \end{align*}

  \machdefc{SessionTypes.Sty}
\end{definition}


\begin{definition}[Contractivity]
  \label{def:contractivity}
  The set $\S$ of contractive session types is defined inductively by the
  following inference rules:\footnote{This definition is slightly stricter
  than the one commonly found in the literature because it forbids any
  variable to occur directly after a binder, rather than just forbidding
  types of the form $\mu X_1, \dots, \mu X_n.X_1$. I believe this should not
  reduce the expressiveness of session types.}
  \begin{align*}
    1 \in \S &\\
    \send B.S \in \S &\quad \forall S \in \S \\
    \recv B.S \in \S &\quad \forall S \in \S \\
    S_1 \echoice S_2 \in \S &\quad \forall S_1, S_2 \in \S \\
    S_1 \ichoice S_2 \in \S &\quad \forall S_1, S_2 \in \S \\
    \mu X.S \in \S &\quad \forall S \in \S, S \notin \Var \\
    X \in \S &\quad \forall X \in \Var
  \end{align*}

  \machdefc{Contractive.Contractive}
\end{definition}


\begin{definition}[Wellformedness]
  \label{def:wellformed}
  The predicates $\mathrm{ok}$ and $\mathrm{checked}$ are mutually
  inductively defined by the following inference rules:

  \inference{}{\envimplok{XS}{1}}

  \bigskip

  \inference{\envimplchecked{XS}{S}}
            {\envimplok{XS}{\send B.S}}

  \bigskip

  \inference{\envimplchecked{XS}{S}}
            {\envimplok{XS}{\recv B.S}}

  \bigskip

  \inference{\envimplchecked{XS}{S_1} &
             \envimplchecked{XS}{S_2}}
            {\envimplok{XS}{S_1 \echoice S_2}}

  \bigskip

  \inference{\envimplchecked{XS}{S_1} &
             \envimplchecked{XS}{S_2}}
            {\envimplok{XS}{S_1 \ichoice S_2}}

  \bigskip

  \inference{\envimplok{XS, X}{S}}
            {\envimplok{XS}{\mu X.S}}

  \bigskip

  \inference{}{\envimplchecked{XS, X}{X}}

  \bigskip

  \inference{\envimplok{XS}{S}}
            {\envimplchecked{XS}{S}}

  \begin{eqnarray*}
    &&     \wf{S \in \Ty} \\
    &:\iff& \envimplok{0}{S}
  \end{eqnarray*}

  \machdef{\code{Wellformed.ok}, \code{Wellformed.checked} and \\
    \code{Wellformed.wellformed} resp.}
\end{definition}


\begin{definition}[Trace]
  \label{def:trace}
  Let
  \begin{equation*}
    \Sigma := \{\send x, \recv x \mid x \in \{0, 1\}\} \cup
      \{ \send B, \recv B \mid B \in \Msg\}.
  \end{equation*}
  The set $\Tl$ of traces is defined as
  \begin{equation*}
    \Tl := \Sigma^\omega.
  \end{equation*}
\end{definition}


\begin{definition}[Trace Language]
  \label{def:trace_language}
  Let $\eta\colon \Var \to \Tl$ and $S \in \S$.
  The trace language $L_\eta(S)$ is inductively defined by the following
  equations:
  \begin{eqnarray}
    \label{def:trace_language:1}
    L_\eta(1) &:=& \{ \epsilon \} \\
    \label{def:trace_language:send}
    L_\eta(\send B.S) &:=& \{ \send B \} \concat L_\eta(S) \quad \forall S \in \S \\
    \label{def:trace_language:recv}
    L_\eta(\recv B.S) &:=& \{ \recv B \} \concat L_\eta(S) \quad \forall S \in \S \\
    \label{def:trace_language:echoice}
    L_\eta(S_1 \echoice S_2)
      &:=&   \{ \send 0 \} \concat L_\eta(S_1)
      \union \{ \send 1 \} \concat L_\eta(S_2)
      \quad \forall S_1, S_2 \in \S \\
    \label{def:trace_language:ichoice}
    L_\eta(S_1 \ichoice S_2)
      &:=&   \{ \recv 0 \} \concat L_\eta(S_1)
      \union \{ \recv 1 \} \concat L_\eta(S_2)
      \quad \forall S_1, S_2 \in \S \\
    \label{def:trace_language:mu}
    L_\eta(\mu X.S) &:=& \gfp(LX \mapsto L_{\eta[X \mapsto LX]}(S))
      \quad \forall S \in \S \\
    \label{def:trace_language:var}
    L_\eta(X) &:=& \eta(X)
  \end{eqnarray}
\end{definition}


\begin{definition}[Session Type Equivalence]
  \label{def:equivalence}
  The functional $F_\sequiv\colon (\Ty \times \Ty) \to (\Ty \times \Ty)$
  is defined by the following equation:
  \begin{eqnarray}
    F_\sequiv(\sequiv)
    &:=&     \label{def:equivalence:mu1}
             \{(\mu X.S, S') \| (S[X \mapsto \mu X.S], S') \in \sequiv\} \\
    &\union& \label{def:equivalence:mu2}
             \{(S, \mu X.S') \| (S, S'[X \mapsto \mu X.S']) \in \sequiv\} \\
    &\union& \label{def:equivalence:ichoice}
             \{(S_1 \ichoice S_2, S_1' \ichoice S_2') \| (S_1, S_1') \in \sequiv \land (S_2, S_2') \in \sequiv\} \\
    &\union& \label{def:equivalence:echoice}
             \{(S_1 \echoice S_2, S_1' \echoice S_2') \| (S_1, S_1') \in \sequiv \land (S_2, S_2') \in \sequiv\} \\
    &\union& \label{def:equivalence:send}
             \{(\send B.S, \send B.S') \| (S, S') \in \sequiv\} \\
    &\union& \label{def:equivalence:recv}
             \{(\recv B.S, \recv B.S') \| (S, S') \in \sequiv\} \\
    &\union& \label{def:equivalence:1}
             \{(1,1)\}
  \end{eqnarray}

  The relation $\sequiv \subseteq \Ty \times \Ty$ is defined as the greatest
  fixed point of $F_\sequiv$:
  \begin{equation*}
    \sequiv := \gfp(F_\sequiv).
  \end{equation*}

  \machdef{\code{Equivalence.sequiv\_gen} and \\ \code{Equivalence.sequiv} resp.}
\end{definition}


\begin{theorem}[$\sequiv$ is an Equivalence Relation]
  \label{th:equiv}
  $\sequiv$ is reflexive, symmetric and transitive on wellformed session types.

  \begin{proof}
    \machproof{\code{Reflexivity.sequiv\_reflexive}, \\
      \code{Symmetry.sequiv\_symmetric} and
      \code{Transitivity.sequiv\_transitive} resp.}
  \end{proof}
\end{theorem}



\begin{lemma}[Overriding Exchange]
  \label{lemma:overriding_exchange}
  \begin{eqnarray*}
    &&         \forall f, x, y, a, b. \\
    &&         x \neq y \\
    &\implies& f[x \mapsto a][y \mapsto b] = f[y \mapsto b][x \mapsto a]
  \end{eqnarray*}

  \begin{proof}
    \machproofc{Map.override\_exchange}
  \end{proof}
\end{lemma}


% TODO Case 7 is wrong.
\begin{lemma}[Substitution in $L_\eta$]
  \label{lemma:substitution_trace_language}
  \begin{equation*}
    L_{\eta[X \mapsto L_\eta(T)]}(S) = L_\eta(S[X \mapsto T])
      \quad \forall S \in \Ty, T \in \Ty, X, \eta.
  \end{equation*}
\end{lemma}

\begin{proof}
  Choose $T, X$ arbitrarily. Induction over the construction of $S$.
  \begin{enumerate}
    \item
      \label{case:substitution_trace_language:1}
      $S = 1$.

      Choose $\eta$. By Def. \ref{def:trace_language},
      \begin{eqnarray*}
        &&  L_{\eta[X \mapsto L_\eta(T)]}(1) \\
        &=& \{\epsilon\}
            \quad \text{(by Eq. \ref{def:trace_language:1})} \\
        &=& L_\eta(1)
            \quad \text{(by Eq. \ref{def:trace_language:1})} \\
        &=& L_\eta(1[X \mapsto T])
            \quad \text{(by Def. of substitution)}.
      \end{eqnarray*}

    \item
      \label{case:substitution_trace_language:send}
      $S = \send B.S'$.

      Induction hypothesis:
      \begin{equation*}
        L_{\eta[X \mapsto L_\eta(T)]}(S') = L_\eta(S'[X \mapsto T]) \quad \forall \eta.
      \end{equation*}

      Choose $\eta$.
      \begin{eqnarray*}
        &&  L_{\eta[X \mapsto L_\eta(T)]}(\send B.S') \\
        &=& \{\send B\} \concat L_{\eta[X \mapsto L_\eta(T)]}(S')
            \quad \text{(by Eq. \ref{def:trace_language:send})} \\
        &=& \{\send B\} \concat L_\eta(S'[X \mapsto T])
            \quad \text{(by IH)} \\
        &=& L_\eta(\send B.(S'[X \mapsto T]))
            \quad \text{(by Eq. \ref{def:trace_language:send})} \\
        &=& L_\eta((\send B.S')[X \mapsto T])
            \quad \text{(by Def. of substitution)}.
      \end{eqnarray*}

    \item
      \label{case:substitution_trace_language:recv}
      $S = \recv B.S'$.

      Analogous to case \ref{case:substitution_trace_language:send}.

    \item
      \label{case:substitution_trace_language:echoice}
      $S = S_1 \echoice S_2$.

      Induction hypothesis:
      \begin{eqnarray*}
        &&      L_{\eta[X \mapsto L_\eta(T)]}(S_1) = L_\eta(S_1[X \mapsto T]) \\
        &\land& L_{\eta[X \mapsto L_\eta(T)]}(S_2) = L_\eta(S_2[X \mapsto T])
      \end{eqnarray*}

      Choose $\eta$.
      \begin{eqnarray*}
        &&  L_{\eta[X \mapsto L_\eta(T)]}(S_1 \echoice S_2) \\
        &=& \{\send 0\} . L_{\eta[X \mapsto L_\eta(T)]}(S_1) \union \{\send 1\} . L_{\eta[X \mapsto L_\eta(T)]}(S_2)
            \quad \text{(by Eq. \ref{def:trace_language:echoice})} \\
        &=& \{\send 0\} . L_\eta(S_1[X \mapsto T]) \union \{\send 1\} . L_\eta(S_2[X \mapsto T])
            \quad \text{(by IH)} \\
        &=& L_\eta(S_1[X \mapsto T] \echoice S_2[X \mapsto T])
            \quad \text{(by Eq. \ref{def:trace_language:echoice})} \\
        &=& L_\eta((S_1 \echoice S_2)[X \mapsto T])
            \quad \text{(by def. of substitution)}.
      \end{eqnarray*}

    \item
      \label{case:substitution_trace_language:ichoice}
      $S = S_1 \ichoice S_2$.

      Analogous to case \ref{case:substitution_trace_language:echoice}.

    \item
      \label{case:substitution_trace_language:mu1}
      $S = \mu X.S'$.

      Choose $\eta$.
      \begin{eqnarray*}
        &&  L_{\eta[X \mapsto L_\eta(T)]}(\mu X.S') \\
        &=& \gfp(LX \mapsto L_{\eta[X \mapsto L_\eta(T)][X \mapsto LX]}(S'))
            \quad \text{(by Eq. \ref{def:trace_language:mu})} \\
        &=& \gfp(LX \mapsto L_{\eta[X \mapsto LX]}(S'))
            \quad \text{(by def. of overriding)} \\
        &=& L_\eta(\mu X.S')
            \quad \text{(by Eq. \ref{def:trace_language:mu})} \\
        &=& L_\eta((\mu X.S')[X \mapsto T])
            \quad \text{(by def. of substitution)}. \\
      \end{eqnarray*}

    \item
      \label{case:substitution_trace_language:mu2}
      $S = \mu Y.S'$, $X \neq Y$.

      Induction hypothesis:
      \begin{equation*}
        L_{\eta[X \mapsto L_\eta(T)]}(S') = L_\eta(S'[X \mapsto T]) \quad \forall \eta.
      \end{equation*}

      Choose $\eta$.
      \begin{eqnarray*}
        &&  L_{\eta[X \mapsto L_\eta(T)]}(\mu Y.S') \\
        &=& \gfp(LX \mapsto L_{\eta[X \mapsto L_\eta(T)][Y \mapsto LX]}(S'))
            \quad \text{(by Eq. \ref{def:trace_language:mu})} \\
        &=& \gfp(LX \mapsto L_{\eta[Y \mapsto LX][X \mapsto L_\eta(T)]}(S'))
            \quad \text{(by Lemma \ref{lemma:overriding_exchange})} \\
        &=& \gfp(LX \mapsto L_{\eta[Y \mapsto LX]}(S'[X \mapsto T]))
            \quad \text{(by IH)} \\
        &=& L_\eta(\mu Y.(S'[X \mapsto T]))
            \quad \text{(by Eq. \ref{def:trace_language:mu})} \\
        &=& L_\eta((\mu Y.S')[X \mapsto T])
            \quad \text{(by def. of substitution)}. \\
      \end{eqnarray*}

    \item
      \label{case:substitution_trace_language:var1}
      $S = X$.

      Choose $\eta$.
      \begin{eqnarray*}
        &&  L_{\eta[X \mapsto L_\eta(T)]}(X) \\
        &=& \eta[X \mapsto L_\eta(T)](X)
            \quad \text{(by Eq. \ref{def:trace_language:var})} \\
        &=& L_\eta(T)
            \quad \text{(by def. of overriding)} \\
        &=& L_\eta(X[X \mapsto T])
            \quad \text{(by def. of substitution)}
      \end{eqnarray*}

    \item
      \label{case:substitution_trace_language:var2}
      $S = Y$, $X \neq Y$.

      Choose $\eta$.
      \begin{eqnarray*}
        &&  L_{\eta[X \mapsto L_\eta(T)]}(Y) \\
        &=& \eta[X \mapsto L_\eta(T)](Y)
            \quad \text{(by Eq. \ref{def:trace_language:var})} \\
        &=& \eta(Y)
            \quad \text{(by def. of overriding)} \\
        &=& L_\eta(Y)
            \quad \text{(by Eq. \ref{def:trace_language:var})} \\
        &=& L_\eta(Y[X \mapsto T])
            \quad \text{(by def. of substitution)}
      \end{eqnarray*}

  \end{enumerate}
\end{proof}


\begin{lemma}[Trace Language of $\mu$ Expansion]
  \label{lemma:mu_expansion_trace_language}
  \begin{equation*}
    L_\eta(\mu X.S) = L_\eta(S[X \mapsto \mu X.S]) \quad \forall \eta, X, S.
  \end{equation*}
\end{lemma}

\begin{proof}
  Choose $\eta, X, S$.
  \begin{eqnarray*}
    &&  L_\eta(\mu X.S) \\
    &=& \gfp(LX \mapsto L_{\eta[X \mapsto LX]}(S))
        \quad \text{(by Eq. \ref{def:trace_language:mu})} \\
    &=& L_{\eta[X \mapsto L_\eta(\mu X.S)]}(S)
        \quad \text{(due to $L_\eta(\mu X.S)$ a fixed point)} \\
    &=& L_\eta(S[X \mapsto \mu X.S])
        \quad \text{(by Lemma \ref{lemma:substitution_trace_language})}.
  \end{eqnarray*}
\end{proof}


\begin{lemma}[Substitution Preserves Wellformedness]
  \label{lemma:substitution_wellformedness}
  \begin{eqnarray*}
    &&         \forall S, T, XS, X. \\
    &&         \envimplok{XS}{T} \\
    &\implies& \envimplok{XS, X}{S} \\
    &\implies& \envimplok{XS}{S[X \mapsto T]}.
  \end{eqnarray*}
\end{lemma}

\begin{proof}
  \machproofc{Wellformed.subst\_preserves\_wellformedness}
\end{proof}


\begin{lemma}[Inversion of Wellformedness]
  \label{lemma:inversion_wellformedness}
  \begin{eqnarray*}
    &&      \forall S, S_1, S_2, X. \\
    &&      (\wf{\send B.S} \implies \wf{S}) \\
    &\land& (\wf{\recv B.S} \implies \wf{S}) \\
    &\land& (\wf{S_1 \echoice S_2} \implies \wf{S_1} \land \wf{S_2}) \\
    &\land& (\wf{S_1 \ichoice S_2} \implies \wf{S_1} \land \wf{S_2}) \\
    &\land& (\wf{\mu X.S} \implies \wf{S[X \mapsto \mu X.S]})
  \end{eqnarray*}
\end{lemma}

\begin{proof}
  \machproofc{Wellformed.wellformed\_inv}
\end{proof}


\begin{theorem}[Trace Equality Implies Equivalence]
  \label{th:equality_equivalence}
  \begin{eqnarray*}
    &&         \forall S, S'. \\
    &&         \wf{S} \\
    &\implies& \wf{S'} \\
    &\implies& (\forall \eta.\, L_\eta(S) = L_\eta(S')) \\
    &\implies& S \sequiv S'.
  \end{eqnarray*}
\end{theorem}

\begin{proof}
  Let
  \begin{equation*}
    R := \{(S, S') \| \wf{S}, \wf{S'}, \forall \eta.\, L_\eta(S) = L_\eta(S') \}.
  \end{equation*}
  We will show that
  \begin{equation*}
    R \subseteq F_\sequiv(R)
  \end{equation*}
  which, by the fixed-point theorem, implies
  \begin{equation*}
    R \subseteq \sequiv.
  \end{equation*}

  Choose $(S, S') \in R$.
  Case analysis on the construction of $S$ and $S'$:
  \begin{enumerate}
    \item
      \label{case:equality_equivalence:mu1}
      $(S, S') = (\mu X.T, S')$.

      By Lemma \ref{lemma:mu_expansion_trace_language},
      \begin{equation*}
        \forall \eta.\, L_\eta(T[X \mapsto \mu X.T]) = L_\eta(\mu X.T).
      \end{equation*}
      Thus, by assumption,
      \begin{equation}
        \label{eq:equality_equivalence:1:mu1:ls}
        \forall \eta.\, L_\eta(T[X \mapsto \mu X.T]) = L_\eta(S').
      \end{equation}

      By assumption,
      \begin{equation*}
        \wf{\mu X.T}.
      \end{equation*}
      Thus, by Lemma \ref{lemma:inversion_wellformedness},
      \begin{equation}
        \label{eq:equality_equivalence:1:mu1:wf}
        \wf{T[X \mapsto \mu X.T]}.
      \end{equation}

      Due to Eqs. \ref{eq:equality_equivalence:1:mu1:ls} and
      \ref{eq:equality_equivalence:1:mu1:wf} and by assumption
      $\wf{S'}$,
      \begin{equation*}
        (T[X \mapsto \mu X.T], S') \in R.
      \end{equation*}
      Thus, by Eq. \ref{def:equivalence:mu1},
      \begin{equation*}
        (S, S') = (\mu X.T, S') \in F_\sequiv(R).
      \end{equation*}

    \item
      \label{case:equality_equivalence:mu2}
      $(S, S') = (S, \mu X.T)$.

      Symmetric to case \ref{case:equality_equivalence:mu1}.

    \item
      \label{case:equality_equivalence:send}
      $(S, S') = (\send B.T, \send B.T')$.

      By Def. \ref{def:trace_language},
      \begin{eqnarray*}
        &&      \forall \eta. \\
        &&      L_\eta(\send B.T)  = \{\send B\} \concat L_\eta(T) \\
        &\land& L_\eta(\send B.T') = \{\send B\} \concat L_\eta(T')
      \end{eqnarray*}
      Thus, by inversion of $L_\eta(S) = L_\eta(S')$:
      \begin{equation}
        \label{eq:equality_equivalence:send:ls}
        \forall \eta.\, L_\eta(T) = L_\eta(T').
      \end{equation}

      By Lemma \ref{lemma:inversion_wellformedness},
      \begin{eqnarray}
        \label{eq:equality_equivalence:send:wf:1} &&      \wf{T} \\
        \label{eq:equality_equivalence:send:wf:2} &\land& \wf{T'}
      \end{eqnarray}

      Due to Eqs. \ref{eq:equality_equivalence:send:ls},
      \ref{eq:equality_equivalence:send:wf:1} and
      \ref{eq:equality_equivalence:send:wf:2},
      \begin{equation*}
        (T, T') \in R.
      \end{equation*}
      Thus, by Eq. \ref{def:equivalence:send},
      \begin{equation*}
        (\send B.T, \send B.T') \in F_\sequiv(R).
      \end{equation*}

    \item
      \label{case:equality_equivalence:recv}
      $(S, S') = (\recv B.T, \recv B.T')$.

      Analogous to case \ref{case:equality_equivalence:send}.

    \item
      \label{case:equality_equivalence:echoice}
      $(S, S') = (T_1 \echoice T_2, T_1' \echoice T_2')$.

      By Def. \ref{def:trace_language},
      \begin{eqnarray*}
        &&      \forall \eta. \\
        &&      L_\eta(T_1 \echoice T_2)   = \{\send 0\} \concat L_\eta(T_1) \union \{\send 1\} \concat L_\eta(T_2) \\
        &\land& L_\eta(T_1' \echoice T_2') = \{\send 0\} \concat L_\eta(T_1') \union \{\send 1\} \concat L_\eta(T_2') \\
      \end{eqnarray*}
      Thus, by inversion of $L_\eta(S) = L_\eta(S')$:
      \begin{eqnarray}
        \label{eq:equality_equivalence:echoice:ls:1} && \forall \eta.\, L_\eta(T_1) = L_\eta(T_1') \\
        \label{eq:equality_equivalence:echoice:ls:2} && \forall \eta.\, L_\eta(T_2) = L_\eta(T_2').
      \end{eqnarray}

      By Lemma \ref{lemma:inversion_wellformedness},
      \begin{eqnarray}
        \label{eq:equality_equivalence:echoice:wf:1} &&      \wf{T_1} \\
        \label{eq:equality_equivalence:echoice:wf:2} &\land& \wf{T_2} \\
        \label{eq:equality_equivalence:echoice:wf:3} &\land& \wf{T_1'} \\
        \label{eq:equality_equivalence:echoice:wf:4} &\land& \wf{T_2'}
      \end{eqnarray}

      Due to Eqs.
      \ref{eq:equality_equivalence:echoice:ls:1},
      \ref{eq:equality_equivalence:echoice:ls:2},
      \ref{eq:equality_equivalence:echoice:wf:1},
      \ref{eq:equality_equivalence:echoice:wf:2},
      \ref{eq:equality_equivalence:echoice:wf:3} and
      \ref{eq:equality_equivalence:echoice:wf:4},
      \begin{eqnarray*}
        &&      (T_1, T_1') \in R \\
        &\land& (T_2, T_2') \in R.
      \end{eqnarray*}
      Thus, by Eq. \ref{def:equivalence:echoice},
      \begin{equation*}
        (T_1 \echoice T_2, T_1' \echoice T_2') \in F_\sequiv(R).
      \end{equation*}

    \item
      \label{case:equality_equivalence:ichoice}
      $(S, S') = (T_1 \ichoice T_2, T_1' \ichoice T_2')$.

      Analogous to case \ref{case:equality_equivalence:echoice}.

    \item
      \label{case:equality_equivalence:var1}
      $(S, S') = (X, S')$.

      By assumption,
      \begin{equation*}
        \wf{X}.
      \end{equation*}
      But by inversion of Def. \ref{def:wellformed}, this is impossible.

    \item
      \label{case:equality_equivalence:var2}
      $(S, S') = (S, X)$.

      Symmetric to case \ref{case:equality_equivalence:var1}.

    \item
      \label{case:equality_equivalence:other}
      All other cases are impossible due to the assumption that
      $L_\eta(S) = L_\eta(S')$ for some $\eta$.
  \end{enumerate}
\end{proof}


\begin{definition}[Shape of a Session Type]
  \label{def:shape}
  Let
  \begin{equation*}
    \Shape := \{\unitS, \sendS, \recvS, \echoiceS, \ichoiceS, \muS, \varS \}.
  \end{equation*}
  The function $\shape\colon \Ty \to \Shape$ is inductively defined by the
  following equations:
  \begin{eqnarray*}
    \shape(1) &:=& \unitS \\
    \shape(\send B.S) &:=& \sendS \quad \forall B \in \Msg;\; S \in \Ty \\
    \shape(\recv B.S) &:=& \recvS \quad \forall B \in \Msg;\; S \in \Ty \\
    \shape(S_1 \echoice S_2) &:=& \echoiceS \quad \forall S_1, S_2 \in Ty \\
    \shape(S_1 \ichoice S_2) &:=& \ichoiceS \quad \forall S_1, S_2 \in Ty \\
    \shape(\mu X.S) &:=& \muS \quad \forall X \in \Var;\; S \in Ty \\
    \shape(X) &:=& \varS \quad \forall X \in \Var
  \end{eqnarray*}

  \machdef{\code{Shape.Shape} and \code{Shape.shape} resp.}
\end{definition}


\begin{definition}[Nonequivalence of Session Types]
  \label{def:nsequiv}
  The relation $\nsequiv \subseteq \Ty \times \Ty$ is inductively defined
  by the following inference rules:
  \begin{eqnarray*}
    && S \nsequiv S' \\
      &\implies& \send B.S \nsequiv \send B.S'
      \quad \forall B \in \Msg;\; S,S' \in \Ty \\
    && B \neq B' \\
      &\implies& \send B.S \nsequiv \send B'.S'
      \quad \forall B,B' \in \Msg;\; S,S' \in \Ty \\
    && S \nsequiv S' \\
      &\implies& \recv B.S \nsequiv \recv B.S'
      \quad \forall B \in \Msg;\; S,S' \in \Ty \\
    &&B \neq B' \\
      &\implies& \recv B.S \nsequiv \recv B'.S'
      \quad \forall B,B' \in \Msg;\; S,S' \in \Ty \\
    && S_1 \nsequiv S_1' \\
      &\implies& S_1 \echoice S_2 \nsequiv S_1' \echoice S_2'
      \quad \forall S_1,S_2,S_1',S_2' \in \Ty \\
    && S_2 \nsequiv S_2' \\
      &\implies& S_1 \echoice S_2 \nsequiv S_1' \echoice S_2'
      \quad \forall S_1,S_2,S_1',S_2' \in \Ty \\
    && S_1 \nsequiv S_1' \\
      &\implies& S_1 \ichoice S_2 \nsequiv S_1' \ichoice S_2'
      \quad \forall S_1,S_2,S_1',S_2' \in \Ty \\
    && S_2 \nsequiv S_2' \\
      &\implies& S_1 \ichoice S_2 \nsequiv S_1' \ichoice S_2'
      \quad \forall S_1,S_2,S_1',S_2' \in \Ty \\
    && S \nsequiv S'[X \mapsto \mu X.S'] \\
      &\implies& S \nsequiv \mu X.S'
      \quad \forall X \in \Var;\; S,S' \in \Ty \\
    && S[X \mapsto \mu X.S] \nsequiv S' \\
      &\implies& \mu X.S \nsequiv S'
      \quad \forall X \in \Var;\; S,S' \in \Ty \\
    && \shape(S) \neq \shape(S') \land \shape(S) \neq \muS \land \shape(S') \neq \muS \\
      &\implies& S \nsequiv S'
      \quad \forall S,S' \in \Ty
  \end{eqnarray*}

  \machdefc{Nonequivalence.nsequiv}
\end{definition}


\begin{lemma}[Nonequivalence is Correct]
  \label{lemma:nsequiv_correct}
  \begin{eqnarray*}
    &&         \forall S, S' \in \Ty. \\
    &&         \wf{S} \\
    &\implies& \wf{S'} \\
    &\implies& (S \nsequiv S' \iff \lnot S \sequiv S')
  \end{eqnarray*}

  \machproofc{EquivalenceFacts.nsequiv\_not\_sequiv\_iff}
\end{lemma}


\begin{theorem}[Trace Equality Implies Equivalence (Alternative Proof)]
  \label{th:equality_equivalence2}
  \begin{eqnarray*}
    &&         \forall S, S'. \\
    &&         \wf{S} \\
    &\implies& \wf{S'} \\
    &\implies& \forall \eta.\, L_\eta(S) = L_\eta(S') \\
    &\implies& S \sequiv S'
  \end{eqnarray*}
\end{theorem}

\begin{proof}
  We show, using contraposition and Lemma \ref{lemma:nsequiv_correct},
  that $S \nsequiv S'$ implies $\exists \eta.\, L_\eta(S) \neq L_\eta(S')$.
  Induction over the derivation of $S \nsequiv S'$.

  \begin{enumerate}
    \item
      \label{case:equality_equivalence2:send1}
      $S = \send B.T$; $S' = \send B.T'$; $T \nsequiv T'$.

      By Lemma \ref{lemma:inversion_wellformedness} and assumptions
      $\wf{S}$ and $\wf{S'}$,
      \begin{eqnarray}
        \label{eq:equality_equivalence2:send1:wfT}
        && \wf{T}; \\
        \label{eq:equality_equivalence2:send1:wfT'}
        && \wf{T'}.
      \end{eqnarray}

      By IH as well as Eqs. \ref{eq:equality_equivalence2:send1:wfT} and
      \ref{eq:equality_equivalence2:send1:wfT'},
      \begin{equation}
        \label{eq:equality_equivalence2:send1:neq}
        \exists \eta.\, L_\eta(T) \neq L_\eta(T')
      \end{equation}
      Choose this $\eta$.

      Thus,
      \ref{eq:equality_equivalence2:send1:neq},
      \begin{eqnarray*}
        &&     L_\eta(S) \\
        &=&    L_\eta(\send B.T) \quad \text
               \quad \text{(by assumption)} \\
        &=&    \{\send B\} \concat L_\eta(T)
               \quad \text{(by Def. \ref{def:trace_language:send})} \\
        &\neq& \{\send B\} \concat L_\eta(T')
               \quad \text{(by Eq. \ref{eq:equality_equivalence2:send1:neq})} \\
        &=&    L_\eta(\send B.T')
               \quad \text{(by Def. \ref{def:trace_language:send})} \\
        &=&    L_\eta(S')
               \quad \text{(by assumption)}
      \end{eqnarray*}

    \item
      \label{case:equality_equivalence2:send2}
      $S = \send B.T$; $S' = \send B'.T'$; $B \neq B'$.

      Choose $\eta$ arbitrarily.
      By Def. \ref{def:trace_language:send} and $B \neq B'$,
      \begin{eqnarray*}
        &&     L_\eta(S) \\
        &=&    L_\eta(\send B.T)
               \quad \text{(by assumption)} \\
        &=&    \{\send B\} \concat L_\eta(T)
               \quad \text{(by Def. \ref{def:trace_language:send})} \\
        &\neq& \{\send B'\} \concat L_\eta(T')
               \quad \text{(due to $B \neq B'$)} \\
        &=&    L_\eta(\send B'.T')
               \quad \text{(by Def. \ref{def:trace_language:send})} \\
        &=&    L_\eta(S')
               \quad \text{(by assumption)}
      \end{eqnarray*}

    \item
      \label{case:equality_equivalence2:recv1}
      $S = \recv B.T$; $S' = \recv B.T'$; $T \nsequiv T'$.

      Analogous to case \ref{case:equality_equivalence2:send1}.

    \item
      \label{case:equality_equivalence2:recv2}
      $S = \recv B.T$; $S' = \recv B'.T'$; $B \neq B'$.

      Analogous to case \ref{case:equality_equivalence2:send2}.

    \item
      \label{case:equality_equivalence2:echoice1}
      $S = T_1 \echoice T_2$; $S' = T_1' \echoice T_2'$; $T_1 \nsequiv T_1'$.

      By Lemma \ref{lemma:inversion_wellformedness} as well as assumptions
      $\wf{S}$ and $\wf{S'}$,
      \begin{eqnarray}
        \label{eq:equality_equivalence2:echoice1:wf1}
        \wf{T_1}; \\
        \label{eq:equality_equivalence2:echoice1:wf2}
        \wf{T_1'}. \\
      \end{eqnarray}

      By IH as well as Eqs. \ref{eq:equality_equivalence2:echoice1:wf1} and
      \ref{eq:equality_equivalence2:echoice1:wf2},
      \begin{equation}
        \label{eq:equality_equivalence2:echoice1:neq}
        \exists \eta.\, L_\eta(T_1) \neq L_\eta(T_1').
      \end{equation}
      Choose this $\eta$.

      Thus,
      \begin{eqnarray*}
        &&     L_\eta(S) \\
        &=&    L_\eta(T_1 \echoice T_2)
               \quad \text{(by assumption)} \\
        &=&    \{\send 0\} \concat L_\eta(T_1) \union \{\send 1\} \concat L_\eta(T_2)
               \quad \text{(by Def. \ref{def:trace_language:echoice})} \\
        &\neq& \{\send 0\} \concat L_\eta(T_1') \union \{\send 1\} \concat L_\eta(T_2')
               \quad \text{(by Eq. \ref{eq:equality_equivalence2:echoice1:neq})} \\
        &=&    L_\eta(T_1' \echoice T_2')
               \quad \text{(by Def. \ref{def:trace_language:echoice})} \\
        &=&    L_\eta(S')
               \quad \text{(by assumption)}
      \end{eqnarray*}

    \item
      \label{case:equality_equivalence2:echoice2}
      $S = T_1 \echoice T_2$; $S' = T_1' \echoice T_2'$; $T_2 \nsequiv T_2'$.

      Symmetric to case \ref{case:equality_equivalence2:echoice1}.

    \item
      \label{case:equality_equivalence2:ichoice1}
      $S = T_1 \ichoice T_2$; $S' = T_1' \ichoice T_2'$; $T_1 \nsequiv T_1'$.

      Analogous to case \ref{case:equality_equivalence2:echoice1}.

    \item
      \label{case:equality_equivalence2:ichoice2}
      $S = T_1 \ichoice T_2$; $S' = T_1' \ichoice T_2'$; $T_2 \nsequiv T_2'$.

      Analogous to case \ref{case:equality_equivalence2:echoice2}.

    \item
      \label{case:equality_equivalence2:mu1}
      $S = \mu X.T$; $T[X \mapsto \mu X.T] \nsequiv S'$.

      By Lemma \ref{lemma:substitution_wellformedness} and assumption
      $\wf{\mu X.T}$,
      \begin{equation}
        \label{eq:equality_equivalence2:mu1:wf}
        \wf{T[X \mapsto \mu X.T]}.
      \end{equation}

      By IH and Eq. \ref{eq:equality_equivalence2:mu1:wf},
      \begin{equation}
        \label{eq:equality_equivalence2:mu1:neq}
        \exists \eta.\, L_\eta(T[X \mapsto \mu X.T]) \neq L_\eta(S')
      \end{equation}
      Choose this $\eta$.

      Thus, by Lemma \ref{lemma:mu_expansion_trace_language},
      \begin{equation}
        \label{eq:equality_equivalence2:mu1:neq'}
        L_{\eta[X \mapsto L_\eta(\mu X.T)]}(T) \neq L_\eta(S').
      \end{equation}

      Thus,
      \begin{eqnarray*}
        &&     L_\eta(\mu X.T) \\
        &=&    L_{\eta[X \mapsto L_\eta(\mu X.T)]}(T)
               \quad \text{(by Def. \ref{def:trace_language:mu})} \\
        &\neq& L_\eta(S').
               \quad \text{(by Eq. \ref{eq:equality_equivalence2:mu1:neq'})}
      \end{eqnarray*}

    \item
      \label{case:equality_equivalence2:mu2}
      $S' = \mu X.T'$; $S \nsequiv T'[X \mapsto \mu X.T']$.

      Symmetric to case \ref{case:equality_equivalence2:mu1}.

    \item
      \label{case:equality_equivalence2:shape}
      $\shape(S) \neq \shape(S')$; $\shape(S) \neq \muS$; $\shape(S') \neq \muS$.

      Trivial by case analysis on $S$ and $S'$ as well as the definition
      of $L_\eta$.
  \end{enumerate}
\end{proof}
\end{document}
