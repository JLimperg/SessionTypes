%TODO define command for unit; semantic commands for other Stys
%TODO clear up references to equations of definitions
\documentclass{llncs}
\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{amsfonts}
\usepackage{semantic}
\usepackage{csquotes}

\newcommand*{\Nat}{\mathbb{N}}
\newcommand*{\Msg}{\mathrm{Msg}}
\newcommand*{\Var}{\mathrm{Var}}
\newcommand*{\Sym}{\mathrm{Sym}}
\newcommand*{\Refl}{\mathrm{Refl}}
\newcommand*{\Trans}{\mathrm{Trans}}
\newcommand*{\Ty}{\mathrm{Ty}}
\newcommand*{\Tl}{\mathrm{Tl}}
\renewcommand*{\S}{\mathfrak{S}}
\newcommand*{\lfp}{\mathrm{lfp}}
\newcommand*{\gfp}{\mathrm{gfp}}
\newcommand*{\bisim}{\approx}
\newcommand*{\cs}{\mathrm{cs}}
\newcommand*{\mul}{\mathrm{mul}}
\newcommand*{\Shape}{\mathrm{Shape}}
\newcommand*{\shape}{\mathrm{shape}}
\newcommand*{\unitS}{\mathrm{unitS}}
\newcommand*{\sendS}{\mathrm{sendS}}
\newcommand*{\recvS}{\mathrm{recvS}}
\newcommand*{\echoiceS}{\mathrm{echoiceS}}
\newcommand*{\ichoiceS}{\mathrm{ichoiceS}}
\newcommand*{\muS}{\mathrm{muS}}
\newcommand*{\varS}{\mathrm{varS}}
\newcommand*{\Free}{\mathrm{Free}}
\newcommand*{\Closed}{\mathrm{Closed}}
\newcommand*{\sequiv}{\sim}
\newcommand*{\nsequiv}{\not\sim}
\newcommand*{\union}{\cup}
\newcommand*{\send}{\mathord{!}}
\newcommand*{\recv}{\mathord{?}}
\newcommand*{\echoice}{\oplus}
\newcommand*{\ichoice}{\mathop{\&}}
\newcommand*{\concat}{\cdot}
\newcommand*{\ok}[1]{\text{$#1$ {\normalfont \rmfamily ok}}}
\newcommand*{\checked}[1]{\text{$#1$ {\normalfont \rmfamily checked}}}
\newcommand*{\wf}[1]{\text{$#1$ {\normalfont \rmfamily wellformed}}}
\newcommand*{\contractive}[1]{\text{$#1$ {\normalfont \rmfamily contractive}}}
\newcommand*{\envimpl}       [2]{#1 \vdash #2}
\newcommand*{\envimplchecked}[2]{\envimpl{#1}{\checked{#2}}}
\newcommand*{\envimplok}     [2]{\envimpl{#1}{\ok{#2}}}
\renewcommand*{\|}{\;|\;}
\renewcommand*{\epsilon}{\varepsilon}
\newcommand*{\eqwith}[1]{\mathrel{\overset{\makebox[0pt]{\mbox{\normalfont\tiny\rmfamily #1}}}{=}}}
\newcommand*{\machdef}[1]{Machine definition: #1}
\newcommand*{\machdefc}[1]{Machine definition: \code{#1}.}
\newcommand*{\machproof}[1]{Machine proof: #1}
\newcommand*{\machproofc}[1]{Machine proof: \code{#1}.}
\newcommand*{\code}[1]{\texttt{#1}}

\begin{document}
\title{Two Definitions of Equivalence on Session Types}
\author{Jannis Limperg}
\institute{Freiburg University}
\maketitle

\begin{definition}[Messages and Variables]
  $\Msg$ and $\Var$ are disjunct infinite sets equipped with a decidable
  equality.

  In the following, we use $B$ for messages and $X, Y, \dots$ for variables.

  \machdef{\code{Msg.Msg} and \code{Var.Var} resp.}
\end{definition}


\begin{definition}[Session Types]
  The set $\Ty$ of session types is defined inductively by the following
  inference rules:
  \label{def:session_types}
  \begin{align*}
    1 \in \Ty \\
    \send B.S \in Ty &\quad \forall B \in Msg, S \in \Ty \\
    \recv B.S \in Ty &\quad \forall B \in Msg, S \in \Ty \\
    S_1 \echoice S_2 \in \Ty &\quad \forall S_1, S_2 \in \Ty \\
    S_1 \ichoice S_2 \in \Ty &\quad \forall S_1, S_2 \in \Ty \\
    \mu X.S \in \Ty &\quad \forall X \in \Var, S \in \Ty \\
    X \in Ty &\quad \forall X \in \Var
  \end{align*}

  \machdefc{SessionTypes.Sty}
\end{definition}


\begin{definition}[Contractivity]
  \label{def:contractivity}
  The set $\S$ of contractive session types is defined inductively by the
  following inference rules:\footnote{This definition is slightly stricter
  than the one commonly found in the literature because it forbids any
  variable to occur directly after a binder, rather than just forbidding
  types of the form $\mu X_1, \dots, \mu X_n.X_1$. I believe this should not
  reduce the expressiveness of session types.}
  \begin{align*}
    1 \in \S &\\
    \send B.S \in \S &\quad \forall S \in \S \\
    \recv B.S \in \S &\quad \forall S \in \S \\
    S_1 \echoice S_2 \in \S &\quad \forall S_1, S_2 \in \S \\
    S_1 \ichoice S_2 \in \S &\quad \forall S_1, S_2 \in \S \\
    \mu X.S \in \S &\quad \forall S \in \S, S \notin \Var \\
    X \in \S &\quad \forall X \in \Var
  \end{align*}

  \machdefc{Contractive.Contractive}
\end{definition}


\begin{definition}[Wellformedness]
  \label{def:wellformed}
  The predicates $\mathrm{ok}$ and $\mathrm{checked}$ are mutually
  inductively defined by the following inference rules:

  \inference{}{\envimplok{XS}{1}}

  \bigskip

  \inference{\envimplchecked{XS}{S}}
            {\envimplok{XS}{\send B.S}}

  \bigskip

  \inference{\envimplchecked{XS}{S}}
            {\envimplok{XS}{\recv B.S}}

  \bigskip

  \inference{\envimplchecked{XS}{S_1} &
             \envimplchecked{XS}{S_2}}
            {\envimplok{XS}{S_1 \echoice S_2}}

  \bigskip

  \inference{\envimplchecked{XS}{S_1} &
             \envimplchecked{XS}{S_2}}
            {\envimplok{XS}{S_1 \ichoice S_2}}

  \bigskip

  \inference{\envimplok{XS, X}{S}}
            {\envimplok{XS}{\mu X.S}}

  \bigskip

  \inference{}{\envimplchecked{XS, X}{X}}

  \bigskip

  \inference{\envimplok{XS}{S}}
            {\envimplchecked{XS}{S}}

  \begin{eqnarray*}
    &&     \wf{S \in \Ty} \\
    &:\iff& \envimplok{0}{S}
  \end{eqnarray*}

  \machdef{\code{Wellformed.ok}, \code{Wellformed.checked} and \\
    \code{Wellformed.wellformed} resp.}
\end{definition}


\begin{definition}[Trace]
  \label{def:trace}
  Let
  \begin{equation*}
    \Sigma := \{\send x, \recv x \mid x \in \{0, 1\}\} \cup
      \{ \send B, \recv B \mid B \in \Msg\}.
  \end{equation*}
  The set $\Tl$ of traces is defined as
  \begin{equation*}
    \Tl := \Sigma^\omega.
  \end{equation*}
\end{definition}


\begin{definition}[Trace Language]
  \label{def:trace_language}
  Let $\eta\colon \Var \to \Tl$ and $S \in \S$.
  The trace language $L_\eta(S)$ is inductively defined by the following
  equations:
  \begin{eqnarray}
    \label{def:trace_language:1}
    L_\eta(1) &:=& \{ \epsilon \} \\
    \label{def:trace_language:send}
    L_\eta(\send B.S) &:=& \{ \send B \} \concat L_\eta(S) \quad \forall S \in \S \\
    \label{def:trace_language:recv}
    L_\eta(\recv B.S) &:=& \{ \recv B \} \concat L_\eta(S) \quad \forall S \in \S \\
    \label{def:trace_language:echoice}
    L_\eta(S_1 \echoice S_2)
      &:=&   \{ \send 0 \} \concat L_\eta(S_1)
      \union \{ \send 1 \} \concat L_\eta(S_2)
      \quad \forall S_1, S_2 \in \S \\
    \label{def:trace_language:ichoice}
    L_\eta(S_1 \ichoice S_2)
      &:=&   \{ \recv 0 \} \concat L_\eta(S_1)
      \union \{ \recv 1 \} \concat L_\eta(S_2)
      \quad \forall S_1, S_2 \in \S \\
    \label{def:trace_language:mu}
    L_\eta(\mu X.S) &:=& \gfp(LX \mapsto L_{\eta[X \mapsto LX]}(S))
      \quad \forall S \in \S \\
    \label{def:trace_language:var}
    L_\eta(X) &:=& \eta(X)
  \end{eqnarray}
\end{definition}


\begin{definition}[Session Type Equivalence]
  \label{def:equivalence}
  The functional $F_\sequiv\colon (\Ty \times \Ty) \to (\Ty \times \Ty)$
  is defined by the following equation:
  \begin{eqnarray}
    F_\sequiv(\sequiv)
    &:=&     \label{def:equivalence:mu1}
             \{(\mu X.S, S') \| (S[X \mapsto \mu X.S], S') \in \sequiv\} \\
    &\union& \label{def:equivalence:mu2}
             \{(S, \mu X.S') \| (S, S'[X \mapsto \mu X.S']) \in \sequiv\} \\
    &\union& \label{def:equivalence:ichoice}
             \{(S_1 \ichoice S_2, S_1' \ichoice S_2') \| (S_1, S_1') \in \sequiv \land (S_2, S_2') \in \sequiv\} \\
    &\union& \label{def:equivalence:echoice}
             \{(S_1 \echoice S_2, S_1' \echoice S_2') \| (S_1, S_1') \in \sequiv \land (S_2, S_2') \in \sequiv\} \\
    &\union& \label{def:equivalence:send}
             \{(\send B.S, \send B.S') \| (S, S') \in \sequiv\} \\
    &\union& \label{def:equivalence:recv}
             \{(\recv B.S, \recv B.S') \| (S, S') \in \sequiv\} \\
    &\union& \label{def:equivalence:1}
             \{(1,1)\}
  \end{eqnarray}

  The relation $\sequiv \subseteq \Ty \times \Ty$ is defined as the greatest
  fixed point of $F_\sequiv$:
  \begin{equation*}
    \sequiv := \gfp(F_\sequiv).
  \end{equation*}

  \machdef{\code{Equivalence.sequiv\_gen} and \\ \code{Equivalence.sequiv} resp.}
\end{definition}


\begin{theorem}[$\sequiv$ is an Equivalence Relation]
  \label{th:equiv}
  $\sequiv$ is reflexive, symmetric and transitive on wellformed session types.

  \begin{proof}
    \machproof{\code{Reflexivity.sequiv\_reflexive}, \\
      \code{Symmetry.sequiv\_symmetric} and
      \code{Transitivity.sequiv\_transitive} resp.}
  \end{proof}
\end{theorem}



\begin{lemma}[Overriding Exchange]
  \label{lemma:overriding_exchange}
  \begin{eqnarray*}
    &&         \forall f, x, y, a, b. \\
    &&         x \neq y \\
    &\implies& f[x \mapsto a][y \mapsto b] = f[y \mapsto b][x \mapsto a]
  \end{eqnarray*}

  \begin{proof}
    \machproofc{Map.override\_exchange}
  \end{proof}
\end{lemma}


\begin{definition}[Free Variables]
  \label{def:free}
  The relation $\Free \subseteq \Var \times \Ty$ is defined inductively
  by the following inference rules:
  \begin{eqnarray*}
    && (X, S) \in \Free \\
    &\implies& (X, \send B.S) \in \Free
    \quad \forall X \in \Var;\; B \in \Msg;\; S \in \Ty \\
    && (X, S) \in \Free \\
    &\implies& (X, \recv B.S) \in \Free
    \quad \forall X \in \Var;\; B \in \Msg;\; S \in \Ty \\
    && (X, S_1) \in \Free \lor (X, S_2) \in \Free \\
    &\implies& (X, S_1 \echoice S_2) \in \Free
    \quad \forall X \in \Var;\; S_1, S_2 \in \Ty \\
    && (X, S_1) \in \Free \lor (X, S_2) \in \Free \\
    &\implies& (X, S_1 \ichoice S_2) \in \Free
    \quad \forall X \in \Var;\; S_1, S_2 \in \Ty \\
    && (X, S) \in \Free \land X \neq Y \\
    &\implies& (X, \mu Y.S) \in \Free
    \quad \forall X, Y \in \Var;\; S \in \Ty \\
    && (X, X) \in \Free \\
    \quad \forall X \in \Var.
  \end{eqnarray*}
  Read $(X, S) \in \Free$ as \enquote{$X$ is free in $S$}.

  \machdefc{Free.Free}
\end{definition}


\begin{definition}[Closedness]
  \label{def:closed}
  The predicate $\Closed \subseteq \Ty$ is defined by
  \begin{equation*}
    \Closed := \{ S \in \Ty \mid \nexists X \in \Var.\; (X, S) \in \Free \}
  \end{equation*}

  \machdefc{Free.Closed}
\end{definition}


\begin{lemma}[Wellformedness Implies Closedness]
  \label{lemma:wellformed_closed}
  \begin{equation*}
    \wf{S} \implies S \in \Closed \quad \forall S \in \Ty
  \end{equation*}
\end{lemma}

\begin{proof}
  \machproofc{FreeFacts.wellformed\_closed}
\end{proof}


\begin{lemma}[Irrelevance of Eta I]
  \label{lemma:eta_irrelevant1}
  \begin{eqnarray*}
    &&         \forall S \in \Ty;\; \eta, \eta'\colon \Var \to \Tl. \\
    &&         (\forall X \in \Var.\; (X, S) \in \Free \implies \eta(X) = \eta'(X)) \\
    &\implies& L_\eta(S) = L_{\eta'}(S).
  \end{eqnarray*}
\end{lemma}

\begin{proof}
  Auxiliary lemma:
  \begin{eqnarray*}
    &&      \forall P. \\
    &&      (\forall B, S.\; (\forall X.\; (X.\; \send B.S) \in \Free \implies P) \\
    &&      \implies \forall X.\; (X, S) \in \Free \implies P) \\
    &\land& (\forall B, S.\; (\forall X.\; (X.\; \recv B.S) \in \Free \implies P) \\
    &&      \implies \forall X.\; (X, S) \in \Free \implies P) \\
    &\land& (\forall S_1, S_2.\; (\forall X.\; (X.\; S_1 \echoice S_2) \in \Free \implies P) \\
    &&      \implies (\forall X.\; (X, S_1) \in \Free \implies P) \land (\forall X.\; (X, S_2) \in \Free \implies P)) \\
    &\land& (\forall S_1, S_2.\; (\forall X.\; (X, S_1 \ichoice S_2) \in \Free \implies P) \\
    &&      \implies (\forall X.\; (X, S_1) \in \Free \implies P) \land (\forall X.\; (X, S_2) \in \Free \implies P)) \\
    &\land& (\forall Y S.\; (\forall X.\; (X, \mu Y.S) \in \Free \implies P) \\
    &&      \implies (\forall X.\; (X, S) \in \Free \land X \neq Y \implies P)).
  \end{eqnarray*}
  \machproofc{FreeFacts.eta\_irrelevant\_helper}

  \bigskip

  Induction over the construction of $S$. In every case, choose $\eta$ and
  $\eta'$ arbitrarily.

  \begin{enumerate}
    \item
      \label{case:eta_irrelevant1:1}
      $S = 1$.

      By Eq. \ref{def:trace_language:1},
      \begin{equation*}
        L_\eta(1) = \{\varepsilon\} = L_{\eta'}(1)
      \end{equation*}

    \item
      \label{case:eta_irrelevant1:send}
      $S = \send B.S'$.

      Induction hypothesis:
      \begin{eqnarray*}
        &&         \forall \eta, \eta'.\; \\
        &&         (\forall X \in \Var.\; (X, S') \in \Free \implies \eta(X) = \eta'(X)) \\
        &\implies& L_\eta(S') = L_{\eta'}(S').
      \end{eqnarray*}

      By aux. lemma and assumption,
      \begin{equation}
        \label{eq:eta_irrelevant1:send:free}
        (\forall X.\; (X, S') \in \Free \implies \eta(X) = \eta'(X))
      \end{equation}

      Thus,
      \begin{eqnarray*}
        &&  L_\eta(S) \\
        &=& L_\eta(\send B.S')
        \quad \text{(by assumption)} \\
        &=& \{\send B\} \concat L_\eta(S')
        \quad \text{(by Eq. \ref{def:trace_language:send})} \\
        &=& \{\send B\} \concat L_{\eta'}(S')
        \quad \text{(by IH, using Eq. \ref{eq:eta_irrelevant1:send:free})} \\
        &=& L_{\eta'}(\send B.S')
        \quad \text{(by Eq. \ref{def:trace_language:send})} \\
        &=&  L_{\eta'}(S)
        \quad \text{(by assumption)}
      \end{eqnarray*}

    \item
      \label{case:eta_irrelevant1:recv}
      $S = \recv B.S'$.

      Analogous to case \ref{case:eta_irrelevant1:send}.

    \item
      \label{case:eta_irrelevant1:echoice}
      $S = S_1 \echoice S_2$.

      Induction hypotheses:
      \begin{eqnarray*}
        &&         \forall \eta, \eta'.\; \\
        &&         (\forall X \in \Var.\; (X, S_1) \in \Free \implies \eta(X) = \eta'(X)) \\
        &\implies& L_\eta(S_1) = L_{\eta'}(S_1). \\
        &&         \forall \eta, \eta'.\; \\
        &&         (\forall X \in \Var.\; (X, S_2) \in \Free \implies \eta(X) = \eta'(X)) \\
        &\implies& L_\eta(S_2) = L_{\eta'}(S_2).
      \end{eqnarray*}

      By aux. lemma and assumption,
      \begin{eqnarray}
        && \label{eq:eta_irrelevant1:echoice:free1}
        (\forall X.\; (X, S_1) \in \Free \implies \eta(X) = \eta'(X)) \\
        &\land& \label{eq:eta_irrelevant1:echoice:free2}
        (\forall X.\; (X, S_2) \in \Free \implies \eta(X) = \eta'(X))
      \end{eqnarray}

      Thus,
      \begin{eqnarray*}
        &&  L_\eta(S) \\
        &=& L_\eta(S_1 \echoice S_2)
        \quad \text{(by assumption)} \\
        &=& \{\send 0\} \concat L_\eta(S_1) \cup \{\send 1\} \concat L_\eta(S_2)
        \quad \text{(by Eq. \ref{def:trace_language:echoice})} \\
        &=& \{\send 0\} \concat L_{\eta'}(S_1) \cup \{\send 1\} \concat L_{\eta'}(S_2)
        \quad \text{(by IHs, using Eqs. \ref{eq:eta_irrelevant1:echoice:free1} and \ref{eq:eta_irrelevant1:echoice:free2})} \\
        &=& L_{\eta'}(S_1 \echoice S_2)
        \quad \text{(by Eq. \ref{def:trace_language:echoice})} \\
        &=&  L_{\eta'}(S)
        \quad \text{(by assumption)}
      \end{eqnarray*}

    \item
      \label{case:eta_irrelevant1:ichoice}
      $S = S_1 \ichoice S_2$.

      Analogous to case \ref{case:eta_irrelevant1:echoice}.

    \item
      \label{case:eta_irrelevant1:mu}
      $S = \mu Y.S'$.

      Induction hypothesis:
      \begin{eqnarray*}
        &&         \forall \eta, \eta'.\; \\
        &&         (\forall X \in \Var.\; (X, S_1) \in \Free \implies \eta(X) = \eta'(X)) \\
        &\implies& L_\eta(S') = L_{\eta'}(S').
      \end{eqnarray*}

      By aux. lemma and assumption,
      \begin{equation}
        \label{eq:eta_irrelevant1:mu:free1}
        \forall X.\; (S', X) \in \Free \land X \neq Y \implies \eta(X) = \eta'(X)
      \end{equation}

      Thus, by the definition of overriding,
      \begin{equation}
        \label{eq:eta_irrelevant1:mu:free2}
        \forall L, X.\; (S', X) \in \Free \implies \eta[Y \mapsto L](X) = \eta'[Y \mapsto L](X)
      \end{equation}

      Thus,
      \begin{eqnarray*}
        &&  L_\eta(S) \\
        &=& L_\eta(\mu Y.S')
        \quad \text{(by assumption)} \\
        &=& \gfp(LX \mapsto L_{\eta[Y \mapsto LX]}(S'))
        \quad \text{(by Eq. \ref{def:trace_language:mu})} \\
        &=& \gfp(LX \mapsto L_{\eta'[Y \mapsto LX]}(S'))
        \quad \text{(by IH, using Eq. \ref{eq:eta_irrelevant1:mu:free2})} \\
        &=& L_{\eta'}(\mu Y.S')
        \quad \text{(by Eq. \ref{def:trace_language:mu})} \\
        &=&  L_{\eta'}(S)
        \quad \text{(by assumption)}
      \end{eqnarray*}

    \item
      \label{case:eta_irrelevant1:var}
      $S = X$.

      By Def. \ref{def:free},
      \begin{equation}
        (X, X) \in \Free.
      \end{equation}
      Thus, by assumption,
      \begin{equation}
        \label{eq:eta_irrelevant1:var:eta}
        \eta(X) = \eta'(X).
      \end{equation}

      Thus,
      \begin{eqnarray*}
        && L_\eta(S) \\
        &=& L_\eta(X)
        \quad \text{(by assumption)} \\
        &=& \eta(X)
        \quad \text{(by Eq. \ref{def:trace_language:var})} \\
        &=& \eta'(X)
        \quad \text{(by Eq. \ref{eq:eta_irrelevant1:var:eta})} \\
        &=& L_{\eta'}(X)
        \quad \text{(by Eq. \ref{def:trace_language:var})} \\
        &=& L_{\eta'}(S)
        \quad \text{(by assumption)}
      \end{eqnarray*}

  \end{enumerate}
\end{proof}


\begin{lemma}[Irrelevance of Eta II]
  \label{lemma:eta_irrelevant2}
  \begin{eqnarray*}
    &&         \forall S \in \Ty. \\
    &&         S \in \Closed \\
    &\implies& \forall \eta, \eta'.\; L_\eta(S) = L_\eta(S').
  \end{eqnarray*}
\end{lemma}

\begin{proof}
  By Lemma \ref{lemma:eta_irrelevant1}. By Def. \ref{def:closed}, there
  is no $X$ such that $(X, S) \in \Free$, so the lemma's precondition
  is vacuously true.
\end{proof}


\begin{lemma}[Substitution in $L_\eta$]
  \label{lemma:substitution_trace_language}
  \begin{eqnarray*}
    &&         \forall S, T \in \Ty; X, \eta. \\
    &&         T \in \Closed \\
    &\implies& L_{\eta[X \mapsto L_\eta(T)]}(S) = L_\eta(S[X \mapsto T])
  \end{eqnarray*}
\end{lemma}

\begin{proof}
  Choose $T, X$ arbitrarily such that $T \in \Closed$. Induction over the
  construction of $S$.
  \begin{enumerate}
    \item
      \label{case:substitution_trace_language:1}
      $S = 1$.

      Choose $\eta$. By Def. \ref{def:trace_language},
      \begin{eqnarray*}
        &&  L_{\eta[X \mapsto L_\eta(T)]}(1) \\
        &=& \{\epsilon\}
            \quad \text{(by Eq. \ref{def:trace_language:1})} \\
        &=& L_\eta(1)
            \quad \text{(by Eq. \ref{def:trace_language:1})} \\
        &=& L_\eta(1[X \mapsto T])
            \quad \text{(by Def. of substitution)}.
      \end{eqnarray*}

    \item
      \label{case:substitution_trace_language:send}
      $S = \send B.S'$.

      Induction hypothesis:
      \begin{equation*}
        L_{\eta[X \mapsto L_\eta(T)]}(S') = L_\eta(S'[X \mapsto T]) \quad \forall \eta.
      \end{equation*}

      Choose $\eta$.
      \begin{eqnarray*}
        &&  L_{\eta[X \mapsto L_\eta(T)]}(\send B.S') \\
        &=& \{\send B\} \concat L_{\eta[X \mapsto L_\eta(T)]}(S')
            \quad \text{(by Eq. \ref{def:trace_language:send})} \\
        &=& \{\send B\} \concat L_\eta(S'[X \mapsto T])
            \quad \text{(by IH)} \\
        &=& L_\eta(\send B.(S'[X \mapsto T]))
            \quad \text{(by Eq. \ref{def:trace_language:send})} \\
        &=& L_\eta((\send B.S')[X \mapsto T])
            \quad \text{(by Def. of substitution)}.
      \end{eqnarray*}

    \item
      \label{case:substitution_trace_language:recv}
      $S = \recv B.S'$.

      Analogous to case \ref{case:substitution_trace_language:send}.

    \item
      \label{case:substitution_trace_language:echoice}
      $S = S_1 \echoice S_2$.

      Induction hypothesis:
      \begin{eqnarray*}
        &&      L_{\eta[X \mapsto L_\eta(T)]}(S_1) = L_\eta(S_1[X \mapsto T]) \\
        &\land& L_{\eta[X \mapsto L_\eta(T)]}(S_2) = L_\eta(S_2[X \mapsto T])
      \end{eqnarray*}

      Choose $\eta$.
      \begin{eqnarray*}
        &&  L_{\eta[X \mapsto L_\eta(T)]}(S_1 \echoice S_2) \\
        &=& \{\send 0\} . L_{\eta[X \mapsto L_\eta(T)]}(S_1) \union \{\send 1\} . L_{\eta[X \mapsto L_\eta(T)]}(S_2)
            \quad \text{(by Eq. \ref{def:trace_language:echoice})} \\
        &=& \{\send 0\} . L_\eta(S_1[X \mapsto T]) \union \{\send 1\} . L_\eta(S_2[X \mapsto T])
            \quad \text{(by IH)} \\
        &=& L_\eta(S_1[X \mapsto T] \echoice S_2[X \mapsto T])
            \quad \text{(by Eq. \ref{def:trace_language:echoice})} \\
        &=& L_\eta((S_1 \echoice S_2)[X \mapsto T])
            \quad \text{(by def. of substitution)}.
      \end{eqnarray*}

    \item
      \label{case:substitution_trace_language:ichoice}
      $S = S_1 \ichoice S_2$.

      Analogous to case \ref{case:substitution_trace_language:echoice}.

    \item
      \label{case:substitution_trace_language:mu1}
      $S = \mu X.S'$.

      Choose $\eta$.
      \begin{eqnarray*}
        &&  L_{\eta[X \mapsto L_\eta(T)]}(\mu X.S') \\
        &=& \gfp(LX \mapsto L_{\eta[X \mapsto L_\eta(T)][X \mapsto LX]}(S'))
            \quad \text{(by Eq. \ref{def:trace_language:mu})} \\
        &=& \gfp(LX \mapsto L_{\eta[X \mapsto LX]}(S'))
            \quad \text{(by def. of overriding)} \\
        &=& L_\eta(\mu X.S')
            \quad \text{(by Eq. \ref{def:trace_language:mu})} \\
        &=& L_\eta((\mu X.S')[X \mapsto T])
            \quad \text{(by def. of substitution)}. \\
      \end{eqnarray*}

    \item
      \label{case:substitution_trace_language:mu2}
      $S = \mu Y.S'$, $X \neq Y$.

      Induction hypothesis:
      \begin{equation*}
        L_{\eta[X \mapsto L_\eta(T)]}(S') = L_\eta(S'[X \mapsto T]) \quad \forall \eta.
      \end{equation*}

      Choose $\eta$.
      \begin{eqnarray*}
        &&  L_{\eta[X \mapsto L_\eta(T)]}(\mu Y.S') \\
        &=& \gfp(LX \mapsto L_{\eta[X \mapsto L_\eta(T)][Y \mapsto LX]}(S'))
            \quad \text{(by Eq. \ref{def:trace_language:mu})} \\
        &=& \gfp(LX \mapsto L_{\eta[Y \mapsto LX][X \mapsto L_\eta(T)]}(S'))
            \quad \text{(by Lemma \ref{lemma:overriding_exchange})} \\
        &=& \gfp(LX \mapsto L_{\eta[Y \mapsto LX][X \mapsto L_{\eta[Y \mapsto LX]}(T)]}(S'))
            \quad \text{(by Lemma \ref{lemma:eta_irrelevant2} with $T \in \Closed$)} \\
        &=& \gfp(LX \mapsto L_{\eta[Y \mapsto LX]}(S'[X \mapsto T]))
            \quad \text{(by IH)} \\
        &=& L_\eta(\mu Y.(S'[X \mapsto T]))
            \quad \text{(by Eq. \ref{def:trace_language:mu})} \\
        &=& L_\eta((\mu Y.S')[X \mapsto T])
            \quad \text{(by def. of substitution)}. \\
      \end{eqnarray*}

    \item
      \label{case:substitution_trace_language:var1}
      $S = X$.

      Choose $\eta$.
      \begin{eqnarray*}
        &&  L_{\eta[X \mapsto L_\eta(T)]}(X) \\
        &=& \eta[X \mapsto L_\eta(T)](X)
            \quad \text{(by Eq. \ref{def:trace_language:var})} \\
        &=& L_\eta(T)
            \quad \text{(by def. of overriding)} \\
        &=& L_\eta(X[X \mapsto T])
            \quad \text{(by def. of substitution)}
      \end{eqnarray*}

    \item
      \label{case:substitution_trace_language:var2}
      $S = Y$, $X \neq Y$.

      Choose $\eta$.
      \begin{eqnarray*}
        &&  L_{\eta[X \mapsto L_\eta(T)]}(Y) \\
        &=& \eta[X \mapsto L_\eta(T)](Y)
            \quad \text{(by Eq. \ref{def:trace_language:var})} \\
        &=& \eta(Y)
            \quad \text{(by def. of overriding)} \\
        &=& L_\eta(Y)
            \quad \text{(by Eq. \ref{def:trace_language:var})} \\
        &=& L_\eta(Y[X \mapsto T])
            \quad \text{(by def. of substitution)}
      \end{eqnarray*}

  \end{enumerate}
\end{proof}


\begin{lemma}[Trace Language of $\mu$ Expansion]
  \label{lemma:mu_expansion_trace_language}
  \begin{eqnarray*}
    &&         \forall S \in \Ty; \eta, X. \\
    &&         \mu X.S \in \Closed \\ % TODO change to wf?
    &\implies& L_\eta(\mu X.S) = L_\eta(S[X \mapsto \mu X.S])
  \end{eqnarray*}
\end{lemma}

\begin{proof}
  Choose $\eta, X, S$.
  \begin{eqnarray*}
    &&  L_\eta(\mu X.S) \\
    &=& \gfp(LX \mapsto L_{\eta[X \mapsto LX]}(S))
        \quad \text{(by Eq. \ref{def:trace_language:mu})} \\
    &=& L_{\eta[X \mapsto L_\eta(\mu X.S)]}(S)
        \quad \text{(due to $L_\eta(\mu X.S)$ a fixed point)} \\
    &=& L_\eta(S[X \mapsto \mu X.S])
        \quad \text{(by Lemma \ref{lemma:substitution_trace_language} using $\mu X.S \in \Closed$)}.
  \end{eqnarray*}
\end{proof}


\begin{lemma}[Substitution Preserves Wellformedness]
  \label{lemma:substitution_wellformedness}
  \begin{eqnarray*}
    &&         \forall S, T, XS, X. \\
    &&         \envimplok{XS}{T} \\
    &\implies& \envimplok{XS, X}{S} \\
    &\implies& \envimplok{XS}{S[X \mapsto T]}.
  \end{eqnarray*}
\end{lemma}

\begin{proof}
  \machproofc{Wellformed.subst\_preserves\_wellformedness}
\end{proof}


\begin{lemma}[Mu Expansion Preserves Wellformedness]
  \label{lemma:mu_expansion_wellformedness}
  \begin{eqnarray*}
    &&         \forall S, X. \\
    &&         \wf{\mu X.S} \\
    &\implies& \wf{S[X \mapsto \mu X.S]}.
  \end{eqnarray*}
\end{lemma}

\begin{proof}
  \machproofc{SubstitutionFacts.subst\_ok\_mu}
\end{proof}


\begin{lemma}[Inversion of Wellformedness]
  \label{lemma:inversion_wellformedness}
  \begin{eqnarray*}
    &&      \forall S, S_1, S_2, X. \\
    &&      (\wf{\send B.S} \implies \wf{S}) \\
    &\land& (\wf{\recv B.S} \implies \wf{S}) \\
    &\land& (\wf{S_1 \echoice S_2} \implies \wf{S_1} \land \wf{S_2}) \\
    &\land& (\wf{S_1 \ichoice S_2} \implies \wf{S_1} \land \wf{S_2}) \\
    &\land& (\wf{\mu X.S} \implies \wf{S[X \mapsto \mu X.S]})
  \end{eqnarray*}
\end{lemma}

\begin{proof}
  \machproofc{Wellformed.wellformed\_inv}
\end{proof}


\begin{theorem}[Trace Equality Implies Equivalence]
  \label{th:equality_equivalence}
  \begin{eqnarray*}
    &&         \forall S, S'. \\
    &&         \wf{S} \\
    &\implies& \wf{S'} \\
    &\implies& (\forall \eta.\, L_\eta(S) = L_\eta(S')) \\
    &\implies& S \sequiv S'.
  \end{eqnarray*}
\end{theorem}

\begin{proof}
  Let
  \begin{equation*}
    R := \{(S, S') \| \wf{S}, \wf{S'}, \forall \eta.\, L_\eta(S) = L_\eta(S') \}.
  \end{equation*}
  We will show that
  \begin{equation*}
    R \subseteq F_\sequiv(R)
  \end{equation*}
  which, by the fixed-point theorem, implies
  \begin{equation*}
    R \subseteq \sequiv.
  \end{equation*}

  Choose $(S, S') \in R$.
  Case analysis on the construction of $S$ and $S'$:
  \begin{enumerate}
    \item
      \label{case:equality_equivalence:mu1}
      $(S, S') = (\mu X.T, S')$.

      By assumption $\wf{S}$ and Lemma \ref{lemma:wellformed_closed},
      \begin{equation*}
        S \in \Closed.
      \end{equation*}
      Thus, by Lemma \ref{lemma:mu_expansion_trace_language},
      \begin{equation*}
        \forall \eta.\, L_\eta(T[X \mapsto \mu X.T]) = L_\eta(\mu X.T).
      \end{equation*}
      Thus, by assumption,
      \begin{equation}
        \label{eq:equality_equivalence:1:mu1:ls}
        \forall \eta.\, L_\eta(T[X \mapsto \mu X.T]) = L_\eta(S').
      \end{equation}

      By assumption,
      \begin{equation*}
        \wf{\mu X.T}.
      \end{equation*}
      Thus, by Lemma \ref{lemma:inversion_wellformedness},
      \begin{equation}
        \label{eq:equality_equivalence:1:mu1:wf}
        \wf{T[X \mapsto \mu X.T]}.
      \end{equation}

      Due to Eqs. \ref{eq:equality_equivalence:1:mu1:ls} and
      \ref{eq:equality_equivalence:1:mu1:wf} and by assumption
      $\wf{S'}$,
      \begin{equation*}
        (T[X \mapsto \mu X.T], S') \in R.
      \end{equation*}
      Thus, by Eq. \ref{def:equivalence:mu1},
      \begin{equation*}
        (S, S') = (\mu X.T, S') \in F_\sequiv(R).
      \end{equation*}

    \item
      \label{case:equality_equivalence:mu2}
      $(S, S') = (S, \mu X.T)$.

      Symmetric to case \ref{case:equality_equivalence:mu1}.

    \item
      \label{case:equality_equivalence:send}
      $(S, S') = (\send B.T, \send B.T')$.

      By Def. \ref{def:trace_language},
      \begin{eqnarray*}
        &&      \forall \eta. \\
        &&      L_\eta(\send B.T)  = \{\send B\} \concat L_\eta(T) \\
        &\land& L_\eta(\send B.T') = \{\send B\} \concat L_\eta(T')
      \end{eqnarray*}
      Thus, by inversion of $L_\eta(S) = L_\eta(S')$:
      \begin{equation}
        \label{eq:equality_equivalence:send:ls}
        \forall \eta.\, L_\eta(T) = L_\eta(T').
      \end{equation}

      By Lemma \ref{lemma:inversion_wellformedness},
      \begin{eqnarray}
        \label{eq:equality_equivalence:send:wf:1} &&      \wf{T} \\
        \label{eq:equality_equivalence:send:wf:2} &\land& \wf{T'}
      \end{eqnarray}

      Due to Eqs. \ref{eq:equality_equivalence:send:ls},
      \ref{eq:equality_equivalence:send:wf:1} and
      \ref{eq:equality_equivalence:send:wf:2},
      \begin{equation*}
        (T, T') \in R.
      \end{equation*}
      Thus, by Eq. \ref{def:equivalence:send},
      \begin{equation*}
        (\send B.T, \send B.T') \in F_\sequiv(R).
      \end{equation*}

    \item
      \label{case:equality_equivalence:recv}
      $(S, S') = (\recv B.T, \recv B.T')$.

      Analogous to case \ref{case:equality_equivalence:send}.

    \item
      \label{case:equality_equivalence:echoice}
      $(S, S') = (T_1 \echoice T_2, T_1' \echoice T_2')$.

      By Def. \ref{def:trace_language},
      \begin{eqnarray*}
        &&      \forall \eta. \\
        &&      L_\eta(T_1 \echoice T_2)   = \{\send 0\} \concat L_\eta(T_1) \union \{\send 1\} \concat L_\eta(T_2) \\
        &\land& L_\eta(T_1' \echoice T_2') = \{\send 0\} \concat L_\eta(T_1') \union \{\send 1\} \concat L_\eta(T_2') \\
      \end{eqnarray*}
      Thus, by inversion of $L_\eta(S) = L_\eta(S')$:
      \begin{eqnarray}
        \label{eq:equality_equivalence:echoice:ls:1} && \forall \eta.\, L_\eta(T_1) = L_\eta(T_1') \\
        \label{eq:equality_equivalence:echoice:ls:2} && \forall \eta.\, L_\eta(T_2) = L_\eta(T_2').
      \end{eqnarray}

      By Lemma \ref{lemma:inversion_wellformedness},
      \begin{eqnarray}
        \label{eq:equality_equivalence:echoice:wf:1} &&      \wf{T_1} \\
        \label{eq:equality_equivalence:echoice:wf:2} &\land& \wf{T_2} \\
        \label{eq:equality_equivalence:echoice:wf:3} &\land& \wf{T_1'} \\
        \label{eq:equality_equivalence:echoice:wf:4} &\land& \wf{T_2'}
      \end{eqnarray}

      Due to Eqs.
      \ref{eq:equality_equivalence:echoice:ls:1},
      \ref{eq:equality_equivalence:echoice:ls:2},
      \ref{eq:equality_equivalence:echoice:wf:1},
      \ref{eq:equality_equivalence:echoice:wf:2},
      \ref{eq:equality_equivalence:echoice:wf:3} and
      \ref{eq:equality_equivalence:echoice:wf:4},
      \begin{eqnarray*}
        &&      (T_1, T_1') \in R \\
        &\land& (T_2, T_2') \in R.
      \end{eqnarray*}
      Thus, by Eq. \ref{def:equivalence:echoice},
      \begin{equation*}
        (T_1 \echoice T_2, T_1' \echoice T_2') \in F_\sequiv(R).
      \end{equation*}

    \item
      \label{case:equality_equivalence:ichoice}
      $(S, S') = (T_1 \ichoice T_2, T_1' \ichoice T_2')$.

      Analogous to case \ref{case:equality_equivalence:echoice}.

    \item
      \label{case:equality_equivalence:var1}
      $(S, S') = (X, S')$.

      By assumption,
      \begin{equation*}
        \wf{X}.
      \end{equation*}
      But by inversion of Def. \ref{def:wellformed}, this is impossible.

    \item
      \label{case:equality_equivalence:var2}
      $(S, S') = (S, X)$.

      Symmetric to case \ref{case:equality_equivalence:var1}.

    \item
      \label{case:equality_equivalence:other}
      All other cases are impossible due to the assumption that
      $L_\eta(S) = L_\eta(S')$ for some $\eta$.
  \end{enumerate}
\end{proof}


\begin{definition}[Shape of a Session Type]
  \label{def:shape}
  Let
  \begin{equation*}
    \Shape := \{\unitS, \sendS, \recvS, \echoiceS, \ichoiceS, \muS, \varS \}.
  \end{equation*}
  The function $\shape\colon \Ty \to \Shape$ is inductively defined by the
  following equations:
  \begin{eqnarray*}
    \shape(1) &:=& \unitS \\
    \shape(\send B.S) &:=& \sendS \quad \forall B \in \Msg;\; S \in \Ty \\
    \shape(\recv B.S) &:=& \recvS \quad \forall B \in \Msg;\; S \in \Ty \\
    \shape(S_1 \echoice S_2) &:=& \echoiceS \quad \forall S_1, S_2 \in Ty \\
    \shape(S_1 \ichoice S_2) &:=& \ichoiceS \quad \forall S_1, S_2 \in Ty \\
    \shape(\mu X.S) &:=& \muS \quad \forall X \in \Var;\; S \in Ty \\
    \shape(X) &:=& \varS \quad \forall X \in \Var
  \end{eqnarray*}

  \machdef{\code{Shape.Shape} and \code{Shape.shape} resp.}
\end{definition}


\begin{definition}[Nonequivalence of Session Types]
  \label{def:nsequiv}
  The relation $\nsequiv \subseteq \Ty \times \Ty$ is inductively defined
  by the following inference rules:
  \begin{eqnarray*}
    && S \nsequiv S' \\
      &\implies& \send B.S \nsequiv \send B.S'
      \quad \forall B \in \Msg;\; S,S' \in \Ty \\
    && B \neq B' \\
      &\implies& \send B.S \nsequiv \send B'.S'
      \quad \forall B,B' \in \Msg;\; S,S' \in \Ty \\
    && S \nsequiv S' \\
      &\implies& \recv B.S \nsequiv \recv B.S'
      \quad \forall B \in \Msg;\; S,S' \in \Ty \\
    &&B \neq B' \\
      &\implies& \recv B.S \nsequiv \recv B'.S'
      \quad \forall B,B' \in \Msg;\; S,S' \in \Ty \\
    && S_1 \nsequiv S_1' \\
      &\implies& S_1 \echoice S_2 \nsequiv S_1' \echoice S_2'
      \quad \forall S_1,S_2,S_1',S_2' \in \Ty \\
    && S_2 \nsequiv S_2' \\
      &\implies& S_1 \echoice S_2 \nsequiv S_1' \echoice S_2'
      \quad \forall S_1,S_2,S_1',S_2' \in \Ty \\
    && S_1 \nsequiv S_1' \\
      &\implies& S_1 \ichoice S_2 \nsequiv S_1' \ichoice S_2'
      \quad \forall S_1,S_2,S_1',S_2' \in \Ty \\
    && S_2 \nsequiv S_2' \\
      &\implies& S_1 \ichoice S_2 \nsequiv S_1' \ichoice S_2'
      \quad \forall S_1,S_2,S_1',S_2' \in \Ty \\
    && S \nsequiv S'[X \mapsto \mu X.S'] \\
      &\implies& S \nsequiv \mu X.S'
      \quad \forall X \in \Var;\; S,S' \in \Ty \\
    && S[X \mapsto \mu X.S] \nsequiv S' \\
      &\implies& \mu X.S \nsequiv S'
      \quad \forall X \in \Var;\; S,S' \in \Ty \\
    && \shape(S) \neq \shape(S') \land \shape(S) \neq \muS \land \shape(S') \neq \muS \\
      &\implies& S \nsequiv S'
      \quad \forall S,S' \in \Ty
  \end{eqnarray*}

  \machdefc{Nonequivalence.nsequiv}
\end{definition}


\begin{lemma}[Nonequivalence is Correct]
  \label{lemma:nsequiv_correct}
  \begin{eqnarray*}
    &&         \forall S, S' \in \Ty. \\
    &&         \wf{S} \\
    &\implies& \wf{S'} \\
    &\implies& (S \nsequiv S' \iff \lnot S \sequiv S')
  \end{eqnarray*}

  \machproofc{EquivalenceFacts.nsequiv\_not\_sequiv\_iff}
\end{lemma}


\begin{theorem}[Trace Equality Implies Equivalence (Alternative Proof)]
  \label{th:equality_equivalence2}
  \begin{eqnarray*}
    &&         \forall S, S'. \\
    &&         \wf{S} \\
    &\implies& \wf{S'} \\
    &\implies& \forall \eta.\, L_\eta(S) = L_\eta(S') \\
    &\implies& S \sequiv S'
  \end{eqnarray*}
\end{theorem}

\begin{proof}
  We show, using contraposition and Lemma \ref{lemma:nsequiv_correct},
  that $S \nsequiv S'$ implies $\exists \eta.\, L_\eta(S) \neq L_\eta(S')$.
  Induction over the derivation of $S \nsequiv S'$.

  \begin{enumerate}
    \item
      \label{case:equality_equivalence2:send1}
      $S = \send B.T$; $S' = \send B.T'$; $T \nsequiv T'$.

      By Lemma \ref{lemma:inversion_wellformedness} and assumptions
      $\wf{S}$ and $\wf{S'}$,
      \begin{eqnarray}
        \label{eq:equality_equivalence2:send1:wfT}
        && \wf{T}; \\
        \label{eq:equality_equivalence2:send1:wfT'}
        && \wf{T'}.
      \end{eqnarray}

      By IH as well as Eqs. \ref{eq:equality_equivalence2:send1:wfT} and
      \ref{eq:equality_equivalence2:send1:wfT'},
      \begin{equation}
        \label{eq:equality_equivalence2:send1:neq}
        \exists \eta.\, L_\eta(T) \neq L_\eta(T')
      \end{equation}
      Choose this $\eta$.

      Thus,
      \ref{eq:equality_equivalence2:send1:neq},
      \begin{eqnarray*}
        &&     L_\eta(S) \\
        &=&    L_\eta(\send B.T) \quad \text
               \quad \text{(by assumption)} \\
        &=&    \{\send B\} \concat L_\eta(T)
               \quad \text{(by Def. \ref{def:trace_language:send})} \\
        &\neq& \{\send B\} \concat L_\eta(T')
               \quad \text{(by Eq. \ref{eq:equality_equivalence2:send1:neq})} \\
        &=&    L_\eta(\send B.T')
               \quad \text{(by Def. \ref{def:trace_language:send})} \\
        &=&    L_\eta(S')
               \quad \text{(by assumption)}
      \end{eqnarray*}

    \item
      \label{case:equality_equivalence2:send2}
      $S = \send B.T$; $S' = \send B'.T'$; $B \neq B'$.

      Choose $\eta$ arbitrarily.
      By Def. \ref{def:trace_language:send} and $B \neq B'$,
      \begin{eqnarray*}
        &&     L_\eta(S) \\
        &=&    L_\eta(\send B.T)
               \quad \text{(by assumption)} \\
        &=&    \{\send B\} \concat L_\eta(T)
               \quad \text{(by Def. \ref{def:trace_language:send})} \\
        &\neq& \{\send B'\} \concat L_\eta(T')
               \quad \text{(due to $B \neq B'$)} \\
        &=&    L_\eta(\send B'.T')
               \quad \text{(by Def. \ref{def:trace_language:send})} \\
        &=&    L_\eta(S')
               \quad \text{(by assumption)}
      \end{eqnarray*}

    \item
      \label{case:equality_equivalence2:recv1}
      $S = \recv B.T$; $S' = \recv B.T'$; $T \nsequiv T'$.

      Analogous to case \ref{case:equality_equivalence2:send1}.

    \item
      \label{case:equality_equivalence2:recv2}
      $S = \recv B.T$; $S' = \recv B'.T'$; $B \neq B'$.

      Analogous to case \ref{case:equality_equivalence2:send2}.

    \item
      \label{case:equality_equivalence2:echoice1}
      $S = T_1 \echoice T_2$; $S' = T_1' \echoice T_2'$; $T_1 \nsequiv T_1'$.

      By Lemma \ref{lemma:inversion_wellformedness} as well as assumptions
      $\wf{S}$ and $\wf{S'}$,
      \begin{eqnarray}
        \label{eq:equality_equivalence2:echoice1:wf1}
        \wf{T_1}; \\
        \label{eq:equality_equivalence2:echoice1:wf2}
        \wf{T_1'}. \\
      \end{eqnarray}

      By IH as well as Eqs. \ref{eq:equality_equivalence2:echoice1:wf1} and
      \ref{eq:equality_equivalence2:echoice1:wf2},
      \begin{equation}
        \label{eq:equality_equivalence2:echoice1:neq}
        \exists \eta.\, L_\eta(T_1) \neq L_\eta(T_1').
      \end{equation}
      Choose this $\eta$.

      Thus,
      \begin{eqnarray*}
        &&     L_\eta(S) \\
        &=&    L_\eta(T_1 \echoice T_2)
               \quad \text{(by assumption)} \\
        &=&    \{\send 0\} \concat L_\eta(T_1) \union \{\send 1\} \concat L_\eta(T_2)
               \quad \text{(by Def. \ref{def:trace_language:echoice})} \\
        &\neq& \{\send 0\} \concat L_\eta(T_1') \union \{\send 1\} \concat L_\eta(T_2')
               \quad \text{(by Eq. \ref{eq:equality_equivalence2:echoice1:neq})} \\
        &=&    L_\eta(T_1' \echoice T_2')
               \quad \text{(by Def. \ref{def:trace_language:echoice})} \\
        &=&    L_\eta(S')
               \quad \text{(by assumption)}
      \end{eqnarray*}

    \item
      \label{case:equality_equivalence2:echoice2}
      $S = T_1 \echoice T_2$; $S' = T_1' \echoice T_2'$; $T_2 \nsequiv T_2'$.

      Symmetric to case \ref{case:equality_equivalence2:echoice1}.

    \item
      \label{case:equality_equivalence2:ichoice1}
      $S = T_1 \ichoice T_2$; $S' = T_1' \ichoice T_2'$; $T_1 \nsequiv T_1'$.

      Analogous to case \ref{case:equality_equivalence2:echoice1}.

    \item
      \label{case:equality_equivalence2:ichoice2}
      $S = T_1 \ichoice T_2$; $S' = T_1' \ichoice T_2'$; $T_2 \nsequiv T_2'$.

      Analogous to case \ref{case:equality_equivalence2:echoice2}.

    \item
      \label{case:equality_equivalence2:mu1}
      $S = \mu X.T$; $T[X \mapsto \mu X.T] \nsequiv S'$.

      By Lemma \ref{lemma:substitution_wellformedness} and assumption
      $\wf{\mu X.T}$,
      \begin{equation}
        \label{eq:equality_equivalence2:mu1:wf}
        \wf{T[X \mapsto \mu X.T]}.
      \end{equation}

      By IH and Eq. \ref{eq:equality_equivalence2:mu1:wf},
      \begin{equation}
        \label{eq:equality_equivalence2:mu1:neq}
        \exists \eta.\, L_\eta(T[X \mapsto \mu X.T]) \neq L_\eta(S')
      \end{equation}
      Choose this $\eta$.

      By assumption $\wf{S}$ and Lemma \ref{lemma:wellformed_closed},
      \begin{equation*}
        S \in \Closed.
      \end{equation*}
      Thus, by Lemma \ref{lemma:mu_expansion_trace_language},
      \begin{equation}
        \label{eq:equality_equivalence2:mu1:neq'}
        L_{\eta[X \mapsto L_\eta(\mu X.T)]}(T) \neq L_\eta(S').
      \end{equation}

      Thus,
      \begin{eqnarray*}
        &&     L_\eta(\mu X.T) \\
        &=&    L_{\eta[X \mapsto L_\eta(\mu X.T)]}(T)
               \quad \text{(by Def. \ref{def:trace_language:mu})} \\
        &\neq& L_\eta(S').
               \quad \text{(by Eq. \ref{eq:equality_equivalence2:mu1:neq'})}
      \end{eqnarray*}

    \item
      \label{case:equality_equivalence2:mu2}
      $S' = \mu X.T'$; $S \nsequiv T'[X \mapsto \mu X.T']$.

      Symmetric to case \ref{case:equality_equivalence2:mu1}.

    \item
      \label{case:equality_equivalence2:shape}
      $\shape(S) \neq \shape(S')$; $\shape(S) \neq \muS$; $\shape(S') \neq \muS$.

      Trivial by case analysis on $S$ and $S'$ as well as the definition
      of $L_\eta$.
  \end{enumerate}
\end{proof}


\begin{definition}[Complete Substitution]
  \label{def:cs}
  The function $\cs\colon \S \to \S$ is defined recursively by the following
  equations:
  \begin{eqnarray*}
    \cs(\mu X.S) &:=& \cs(S[X \mapsto \mu X.S]) \\
    \cs(S) &:=& S \quad \mid \shape(S) \neq \muS
  \end{eqnarray*}

  \machdefc{CompleteSubstitution.cs}
\end{definition}


\begin{definition}[$\mu$ Prefix Length]
  \label{def:mul}
  The function $\mul\colon \Ty \to \Nat$ is defined recursively by the
  following equations:
  \begin{eqnarray*}
    \mul(\mu X.S) &:=& 1 + \mul(S) \\
    \mul(S) &:=& 0 \quad \mid \shape(S) \neq \muS
  \end{eqnarray*}
\end{definition}


\begin{lemma}[$\mu$ Prefix Length of $\mu$ Expansion]
  \label{lemma:mu_expansion_mul}
  \begin{eqnarray*}
    &&         \forall S, X. \\
    &&         \wf{\mu X.S} \\
    &\implies& \mul(S[X \mapsto \mu X.S]) < \mul(\mu X.S).
  \end{eqnarray*}
\end{lemma}

\begin{proof}
  \machproofc{SubstitutionFacts.lt\_Sty\_mu\_prefix\_subst\_mu}
\end{proof}


\begin{lemma}[Complete Substitution Preserves Trace Language]
  \label{lemma:cs_preserves_trace_language}
  \begin{eqnarray*}
    && \forall S \in \S, \eta. \\
    && \wf{S} \\
    &\implies& L_\eta(S) = L_\eta(\cs(S)).
  \end{eqnarray*}
\end{lemma}

\begin{proof}
  Induction over $n := \mul(S)$.
  \begin{enumerate}
    \item
      $n = 0$.

      By Def. \ref{def:cs}, $cs(S) = S$; thus $L_\eta(S) = L_\eta(\cs(S))$.

    \item
      $n > m$; $S = \mu X_1.\dots.\mu X_n.S'$.

      Induction hypothesis:
      \begin{eqnarray*}
        &&         \forall S_1. \\
        &&         \wf{S_1} \\
        &\implies& \mul(S_1) < \mul(S) \\
        &\implies& L_\eta(S_1) = L_\eta(\cs(S_1)).
      \end{eqnarray*}

      By assumption $\wf{S}$ and Lemma \ref{lemma:wellformed_closed},
      \begin{equation}
        \label{eq:cs_preserves_trace_language:closed}
        S \in \Closed.
      \end{equation}
      By assumption $\wf{S}$ and Lemma \ref{lemma:mu_expansion_wellformedness}
      \begin{equation}
        \label{eq:cs_preserves_trace_language:wf}
        \wf{(\mu X_2.\dots.\mu X_n.S')[X_1 \mapsto S]}
      \end{equation}
      By assumption $\wf{S}$ and Lemma \ref{lemma:mu_expansion_mul},
      \begin{equation}
        \label{eq:cs_preserves_trace_language:mul}
        \mul((\mu X_2.\dots.\mu X_n.S')[X_1 \mapsto S]) < \mul(S)
      \end{equation}
      Thus,
      \begin{eqnarray*}
        &&  L_\eta(S) \\
        &=& L_\eta(\mu X_1.\dots.\mu X_n.S')
          \quad \text{(by assumption)} \\
        &=& L_\eta((\mu X_2.\dots.\mu X_n.S')[X_1 \mapsto S])
          \quad \text{(by Lemma \ref{lemma:mu_expansion_trace_language}
          using Eq. \ref{eq:cs_preserves_trace_language:closed})} \\
        &=& L_\eta(\cs((\mu X_2.\dots.\mu X_n.S')[X_1 \mapsto S]))
          \quad \text{(by IH using Eqs. \ref{eq:cs_preserves_trace_language:wf}
          and \ref{eq:cs_preserves_trace_language:mul})} \\
        &=& L_\eta(\cs(\mu X_1.\dots.\mu X_n.S'))
          \quad \text{(by Def. \ref{def:cs})} \\
        &=& L_\eta(\cs(S))
          \quad \text{(by assumption)}
      \end{eqnarray*}
  \end{enumerate}
\end{proof}


\begin{lemma}[Complete Substitution Preserves Equivalence]
  \label{lemma:cs_preserves_sequiv}
  \begin{eqnarray*}
    &&         \forall S, S'. \\
    &&         \wf{S} \\
    &\implies& \wf{S'} \\
    &\implies& S \sequiv S' \\
    &\implies& \cs(S) \sequiv \cs(S')
  \end{eqnarray*}
\end{lemma}

\begin{proof}
  \machproofc{CompleteSubstitutionFacts.cs\_preserves\_sequiv}
\end{proof}


\begin{lemma}[Complete Substitution Preserves Wellformedness]
  \label{lemma:cs_preserves_wellformedness}
  \begin{eqnarray*}
    &&         \forall S. \\
    &&         \wf{S} \\
    &\implies& \wf{\cs(S)}.
  \end{eqnarray*}
\end{lemma}

\begin{proof}
  \machproofc{CompleteSubstitutionFacts.cs\_preserves\_wellformedness}
\end{proof}


\begin{definition}[Bisimilarity on Trace Languages]
  \label{def:tl_bisim}
  The functional $F_\bisim\colon (\Tl \times \Tl) \to (\Tl \times \Tl)$ is
  defined by the following equation:
  \begin{eqnarray*}
    F_\bisim(\bisim)
    &:=&   \{ (\{\epsilon\}, \{\epsilon\})\} \\
    &\cup& \{ (\{\send B\}.L, \{\send B\}.L') \mid L \bisim L' \} \\
    &\cup& \{ (\{\recv B\}.L, \{\recv B\}.L') \mid L \bisim L' \} \\
    &\cup& \{ (\{\send 0\}.L_1 \cup \{\send 1\}.L_2, \{\send 0\}.L_1' \cup \{\send 1\}.L_2')
              \mid L_1 \bisim L_1' \land L_2 \bisim L_2' \} \\
    &\cup& \{ (\{\recv 0\}.L_1 \cup \{\recv 1\}.L_2, \{\recv 0\}.L_1' \cup \{\recv 1\}.L_2')
              \mid L_1 \bisim L_1' \land L_2 \bisim L_2' \}.
  \end{eqnarray*}
  $\bisim \subseteq \Tl \times \Tl$ is the greatest fixed point of $F_\bisim$:
  \begin{equation*}
    \bisim := \gfp(F_\bisim).
  \end{equation*}
\end{definition}


\begin{theorem}[Equivalence implies Trace Bisimilarity]
  \label{th:equivalence_equality}
  \begin{eqnarray*}
    &&         \forall S, S'. \\
    &&         \wf{S} \\
    &\implies& \wf{S'} \\
    &\implies& S \sequiv S' \\
    &\implies& \forall \eta.\, L_\eta(S) \bisim L_\eta(S')
  \end{eqnarray*}
\end{theorem}

\begin{proof}
  Let $R \subseteq \Tl \times \Tl$ with
  \begin{eqnarray*}
    R :=
    &\{&   (L, L') \\
    &\mid& \exists S, S'. L = L_\eta(\cs(S));\; L' = L_\eta(\cs(S')) \\
    &;\;&  \wf{\cs(S)};\; \wf{\cs(S')};\; \cs(S) \sequiv \cs(S') \\
    &\}&.
  \end{eqnarray*}

  We will show $R \subseteq F_\bisim(R)$, which by the fixed-point theorem
  implies $R \subseteq \bisim = \gfp(F_\bisim)$.

  Choose $L, L' \in R$ and the corresponding $S, S'$. Case analysis on the
  construction of $\cs(S) \sequiv \cs(S')$.
  \begin{enumerate}
    \item
      \label{case:equivalence_equality:unit}
      $\cs(S) = \cs(S') = 1$.

      \begin{eqnarray*}
        &&  (L_\eta(\cs(S)), L_\eta(\cs(S')) \\
        &=& (L_\eta(1), L_\eta(1))
        \quad \text{(by assumption)} \\
        &=& (\{\varepsilon\}, \{\varepsilon\})
        \quad \text{(by Eq. \ref{def:trace_language:1})} \\
        &\in& F_\bisim(R)
        \quad \text{(by Def. \ref{def:tl_bisim})}
      \end{eqnarray*}

    \item
      \label{case:equivalence_equality:send}
      $\cs(S) = \send B.S_1$; $\cs(S') = \send B.S_1'$; $S_1 \sequiv S_1'$.

      By Lemma \ref{lemma:inversion_wellformedness} and assumptions
      $\wf{\cs(S)}$ resp. $\wf{\cs(S')}$,
      \begin{equation*}
        \wf{S_1} \land \wf{S_1'}.
      \end{equation*}
      Thus, By Lemma \ref{lemma:cs_preserves_wellformedness},
      \begin{equation}
        \label{eq:equivalence_equality:send:wf}
        \wf{\cs(S_1)} \land \wf{\cs(S_1')}.
      \end{equation}

      By Lemma \ref{lemma:cs_preserves_sequiv} and assumption
      $S_1 \sequiv S_1'$,
      \begin{equation}
        \label{eq:equivalence_equality:send:sequiv}
        \cs(S_1) \sequiv \cs(S_1').
      \end{equation}

      Due to Eqs. \ref{eq:equivalence_equality:send:wf} and
      \ref{eq:equivalence_equality:send:sequiv},
      \begin{equation*}
        (L_\eta(\cs(S_1)), L_\eta(\cs(S_1')) \in R.
      \end{equation*}
      Thus, by Lemma \ref{lemma:cs_preserves_trace_language},
      \begin{equation*}
        (L_\eta(S_1), L_\eta(S_1') \in R.
      \end{equation*}
      Thus,
      \begin{eqnarray*}
        &&  (L_\eta(\cs(S)), L_\eta(\cs(S'))) \\
        &=& (L_\eta(\send B.S_1), L_\eta(\send B.S_1'))
        \quad \text{(by assumption)} \\
        &=& (\{\send B\} \concat L_\eta(S_1), \{\send B\} \concat L_\eta(S_1'))
        \quad \text{(by Eq. \ref{def:trace_language:send})} \\
        &\in& F_\bisim(R)
        \quad \text{(by Def. \ref{def:tl_bisim})}
      \end{eqnarray*}

    \item
      \label{case:equivalence_equality:recv}
      $\cs(S) = \recv B.S_1$; $\cs(S') = \recv B.S_1'$; $S_1 \sequiv S_1'$.

      Analogous to case \ref{case:equivalence_equality:send}.

    \item
      \label{case:equivalence_equality:echoice}
      $\cs(S) = S_1 \echoice S_2$; $\cs(S') = S_1' \echoice S_2'$;
      $S_1 \sequiv S_1'$; $S_2 \sequiv S_2'$.

      By Lemma \ref{lemma:inversion_wellformedness} and assumptions
      $\wf{\cs(S)}$ resp. $\wf{\cs(S')}$,
      \begin{equation*}
        \wf{S_1} \land \wf{S_2} \land \wf{S_1'} \land \wf{S_2'}.
      \end{equation*}
      Thus, By Lemma \ref{lemma:cs_preserves_wellformedness},
      \begin{multline}
        \label{eq:equivalence_equality:echoice:wf}
        \wf{\cs(S_1)} \land \wf{\cs(S_2)} \land \\
        \wf{\cs(S_1')} \land \wf{\cs(S_2')}.
      \end{multline}

      By Lemma \ref{lemma:cs_preserves_sequiv} and assumptions
      $S_1 \sequiv S_1'$ resp. $S_2 \sequiv S_2'$,
      \begin{equation}
        \label{eq:equivalence_equality:echoice:sequiv}
        \cs(S_1) \sequiv \cs(S_1') \land \cs(S_2) \sequiv \cs(S_2').
      \end{equation}

      Due to Eqs. \ref{eq:equivalence_equality:echoice:wf} and
      \ref{eq:equivalence_equality:echoice:sequiv},
      \begin{eqnarray*}
        (L_\eta(\cs(S_1)), L_\eta(\cs(S_1')) \in R \land
        (L_\eta(\cs(S_2)), L_\eta(\cs(S_2')) \in R.
      \end{eqnarray*}
      Thus, by Lemma \ref{lemma:cs_preserves_trace_language},
      \begin{eqnarray*}
        (L_\eta(S_1), L_\eta(S_1') \in R \land
        (L_\eta(S_2), L_\eta(S_2') \in R.
      \end{eqnarray*}
      Thus,
      \begin{eqnarray*}
        &&  (L_\eta(\cs(S)), L_\eta(\cs(S'))) \\
        &=& (L_\eta(S_1 \echoice S_2), L_\eta(S_1' \echoice S_2'))
        \quad \text{(by assumption)} \\
        &=& (\{\send 0\} \concat L_\eta(S_1) \cup \{\send 1\} \concat L_\eta(S_2),
            \{\send 0\} \concat L_\eta(S_1') \cup \{\send 1\} \concat L_\eta(S_2'))
        \quad \text{(by Eq. \ref{def:trace_language:send})} \\
        &\in& F_\bisim(R)
        \quad \text{(by Def. \ref{def:tl_bisim})}
      \end{eqnarray*}

    \item
      \label{case:equivalence_equality:ichoice}
      $\cs(S) = S_1 \ichoice S_2$; $\cs(S') = S_1' \ichoice S_2'$;
      $S_1 \sequiv S_1'$; $S_2 \sequiv S_2'$.

    \item
      All other cases are impossible due to the shape of $\cs(S)$ and
      $\cs(S')$.
  \end{enumerate}

  Now choose $S, S', \eta$. By Lemma \ref{lemma:cs_preserves_wellformedness}
  and assumptions $\wf{S}$ resp. $\wf{S'}$,
  \begin{equation*}
    \wf{\cs(S)} \land \wf{\cs(S')}.
  \end{equation*}
  By Lemma \ref{lemma:cs_preserves_sequiv} and assumption $S \sequiv S'$,
  \begin{equation*}
    \cs(S) \sequiv \cs(S').
  \end{equation*}
  Thus,
  \begin{equation*}
    (L_\eta(\cs(S)), L_\eta(\cs(S'))) \in R
  \end{equation*}
  and due to $R \subseteq \bisim$,
  \begin{equation*}
    L_\eta(\cs(S)) \bisim L_\eta(\cs(S')).
  \end{equation*}
  Thus, by Lemma \ref{lemma:cs_preserves_trace_language},
  \begin{equation*}
    L_\eta(S) \bisim L_\eta(S').
  \end{equation*}
\end{proof}
\end{document}
